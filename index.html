<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Zombie Shooter â€“ Location Based</title>

    <!-- AFRAME COMPATIBLE GPS -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>

    <!-- AR.js GPS MODE (NOT NFT!) -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        #ui-overlay { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; }
        #crosshair { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:40px; height:40px; }
        .crosshair-line { position:absolute; background:rgba(255,0,0,0.8); }
        .h { width:40px; height:2px; top:50%; }
        .v { width:2px; height:40px; left:50%; }
        #score-panel {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0,0,0,.8); padding: 12px 20px;
            border-radius: 8px; font-size:18px; color:#fff; border:2px solid red;
        }
    </style>
</head>

<body>

<div id="ui-overlay" style="display:none;">
    <div id="crosshair">
        <div class="crosshair-line h"></div>
        <div class="crosshair-line v"></div>
    </div>

    <div id="score-panel">
        ðŸ’€ KILLS: <span id="score">0</span>
    </div>
</div>

<div id="instructions">
    <div style="padding:20px; text-align:center; background:black; color:white; border:3px solid lime;">
        <h2>AR Zombie Shooter</h2>
        <p>Zombie akan muncul di sekitar Anda berdasarkan GPS.</p>
        <p><b>Pastikan mengizinkan Kamera + GPS</b></p>
        <button id="start-btn" style="padding:12px 28px; font-size:18px;">Start</button>
    </div>
</div>

<!-- SCENE -->
<a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;"
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled:false; gpsWorldMapping:true;"
>
    <!-- PLAYER CAMERA -->
    <a-entity id="player" camera gps-camera rotation-reader></a-entity>
</a-scene>

<script>
let player;
let scene;
let userLat = null;
let userLon = null;

let zombies = [];
let score = 0;
let gameStarted = false;

document.getElementById("start-btn").addEventListener("click", startGame);

function startGame() {
    document.getElementById("instructions").style.display = "none";
    document.getElementById("ui-overlay").style.display = "block";

    scene = document.querySelector("a-scene");
    player = document.querySelector("#player");

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            userLat = pos.coords.latitude;
            userLon = pos.coords.longitude;

            gameStarted = true;
            setTimeout(spawnZombie, 2000);
        },
        (err) => {
            alert("GPS Error: izinkan GPS");
        },
        { enableHighAccuracy: true }
    );
}

/* ---------- SPAWN ZOMBIE DI DEPAN PLAYER ---------- */
function spawnZombie() {
    if (!player || !player.object3D) return;

    const zombie = createZombie();

    // DAPATKAN POSISI & ARAH KAMERA
    const pos = new THREE.Vector3();
    const dir = new THREE.Vector3();
    player.object3D.getWorldPosition(pos);
    player.object3D.getWorldDirection(dir);

    const distance = 1.0; // 1 meter di depan
    const spawnPos = pos.clone().add(dir.multiplyScalar(distance));

    zombie.setAttribute("position", `${spawnPos.x} ${spawnPos.y - 1} ${spawnPos.z}`);
    zombie.setAttribute("look-at", "#player");

    scene.appendChild(zombie);
    zombies.push(zombie);
}

/* ---------- BENTUK ZOMBIE ---------- */
function createZombie() {
    const z = document.createElement("a-entity");

    const body = document.createElement("a-cylinder");
    body.setAttribute("color", "#2e5e2e");
    body.setAttribute("radius", "0.4");
    body.setAttribute("height", "1");
    body.setAttribute("position", "0 0.5 0");
    z.appendChild(body);

    const head = document.createElement("a-sphere");
    head.setAttribute("color", "#4c7f4c");
    head.setAttribute("radius", "0.3");
    head.setAttribute("position", "0 1.2 0");
    z.appendChild(head);

    z.userData = { health: 100, dead: false };

    return z;
}

/* ---------- SHOOT EVENT ---------- */
document.addEventListener("click", () => {
    if (!gameStarted) return;

    const camPos = new THREE.Vector3();
    const camDir = new THREE.Vector3();
    player.object3D.getWorldPosition(camPos);
    player.object3D.getWorldDirection(camDir);

    const ray = new THREE.Raycaster(camPos, camDir);

    let hit = null;
    let dist = Infinity;

    zombies.forEach(z => {
        if (z.userData.dead) return;

        const hitInfo = ray.intersectObject(z.object3D, true);
        if (hitInfo.length > 0 && hitInfo[0].distance < dist) {
            hit = z;
            dist = hitInfo[0].distance;
        }
    });

    if (hit) {
        hit.userData.health -= 50;
        if (hit.userData.health <= 0) killZombie(hit);
    }
});

/* ---------- KILL ANIMATION ---------- */
function killZombie(z) {
    z.userData.dead = true;
    score++;
    document.getElementById("score").textContent = score;

    let s = 1;
    const fade = setInterval(() => {
        s *= 0.8;
        z.setAttribute("scale", `${s} ${s} ${s}`);
        if (s < 0.1) {
            clearInterval(fade);
            scene.removeChild(z);
            zombies = zombies.filter(k => k !== z);

            setTimeout(spawnZombie, 700);
        }
    }, 50);
}
</script>

</body>
</html>
