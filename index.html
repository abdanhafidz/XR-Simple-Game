<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Zombie Shooter: Final Fix</title>
    
    <!-- A-Frame 1.4.0 & AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    
    <!-- MediaPipe Hands (Versi CDN Stabil) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- Font Cyberpunk -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; }
        
        /* Video Fullscreen Fix */
        #arjs-video, video {
            width: 100% !important; height: 100% !important;
            position: absolute !important; top: 0; left: 0;
            z-index: -2 !important; object-fit: cover !important;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* DEBUG CANVAS (Untuk Cek Hand Tracking) */
        #debug-canvas {
            position: absolute; top: 10px; left: 10px;
            width: 120px; height: 90px;
            border: 2px solid red; z-index: 1000;
            background: rgba(0,0,0,0.5);
            display: block; /* Tampilkan agar user tau AI jalan */
        }

        /* UI ELEMENTS */
        .hud-panel {
            background: rgba(0, 20, 40, 0.8); border: 2px solid #00ffff;
            padding: 10px 20px; transform: skewX(-15deg);
            box-shadow: 0 0 15px #00ffff; margin: 10px;
            backdrop-filter: blur(4px);
        }
        .hud-text { color: #fff; font-size: 24px; transform: skewX(15deg); text-shadow: 0 0 5px #00ffff; }
        .hud-label { font-family: 'Share Tech Mono'; font-size: 10px; color: #00ffff; display: block; margin-bottom: 2px; transform: skewX(15deg); }

        .top-row { display: flex; justify-content: space-between; padding-top: 20px; }
        .bottom-row { display: flex; align-items: flex-end; justify-content: space-between; padding-bottom: 20px; }

        /* CURSOR HIJAU */
        #aim-cursor {
            position: absolute; width: 60px; height: 60px;
            border: 3px solid #0f0; border-radius: 50%;
            transform: translate(-50%, -50%);
            top: 50%; left: 50%; opacity: 0;
            box-shadow: 0 0 20px #0f0; transition: opacity 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        #aim-cursor::after { content: ''; width: 8px; height: 8px; background: #0f0; }

        /* BUTTONS & STATUS */
        #status-msg {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            color: #0ff; font-family: 'Share Tech Mono'; font-size: 14px;
            text-shadow: 0 0 5px #000; background: rgba(0,0,0,0.6); padding: 10px;
            border: 1px solid #0ff; text-align: center;
        }

        #fire-btn {
            position: absolute; bottom: 120px; right: 20px;
            width: 90px; height: 90px; background: rgba(255, 0, 0, 0.3);
            border: 3px solid #ff0000; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 18px; pointer-events: auto;
            box-shadow: 0 0 25px #ff0000; cursor: pointer;
        }
        #fire-btn:active { background: #f00; transform: scale(0.95); }

        /* Health Bar */
        .hp-container { width: 200px; margin-left: 20px; transform: skewX(-15deg); }
        .hp-bar-bg { width: 100%; height: 20px; background: #300; border: 2px solid #ff0000; }
        .hp-bar-fill { width: 100%; height: 100%; background: #ff0000; transition: width 0.2s; box-shadow: 0 0 10px #f00; }

        /* Radar */
        .radar {
            position: absolute; bottom: 20px; left: 20px;
            width: 100px; height: 100px; border: 2px solid #0f0; border-radius: 50%;
            background: rgba(0, 20, 0, 0.7); overflow: hidden;
        }
        .radar-blip { position: absolute; width: 6px; height: 6px; background: red; border-radius: 50%; transform: translate(-50%, -50%); }

        /* SCREENS */
        .screen { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; pointer-events: auto; }
        .btn-main { background: linear-gradient(45deg, #c00, #900); color: #fff; border: none; padding: 20px 50px; font-family: 'Orbitron'; font-size: 24px; margin-top: 20px; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); cursor: pointer; border: 2px solid white; }
    
        #damage-flash { position: absolute; width: 100%; height: 100%; background: radial-gradient(transparent 30%, red); opacity: 0; pointer-events: none; transition: 0.1s; mix-blend-mode: multiply; z-index: 800; }
    </style>
</head>

<body>
    <div id="damage-flash"></div>

    <div id="ui-layer">
        <canvas id="debug-canvas"></canvas> <!-- PENTING: Cek AI disini -->
        
        <div class="top-row">
            <div class="hud-panel" style="border-color: #0ff;">
                <span class="hud-label">KILLS</span>
                <span class="hud-text" id="score">0</span>
            </div>
            <div class="hud-panel" style="border-color: #fa0;">
                <span class="hud-label">WAVE</span>
                <span class="hud-text" id="wave">1</span>
            </div>
        </div>

        <!-- AIMING -->
        <div id="aim-cursor"></div>
        <div id="status-msg">LOADING AI...<br>Tunggu Kamera Ready</div>

        <div class="radar" id="radar"></div>
        <div id="fire-btn">SHOOT</div>

        <div class="bottom-row">
            <div class="hp-container">
                <span class="hud-label" style="color:#fff; margin-left: 10px;">HP INTEGRITY</span>
                <div class="hp-bar-bg"><div class="hp-bar-fill" id="hp-bar"></div></div>
            </div>
            <div class="hud-panel" style="border-color: #f00;">
                <span class="hud-label" style="color:#f55">AMMO</span>
                <span class="hud-text" style="color:#f00" id="ammo">30</span>
            </div>
        </div>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen" class="screen">
        <h1 style="color:red; font-size:40px; text-shadow:0 0 20px red; margin-bottom:10px;">ZOMBIE PROTOCOL</h1>
        <p style="color:#aaa; font-family:'Share Tech Mono';">
            HAND TRACKING MODE<br>
            1. Gunakan Tangan Kanan di DEPAN Kamera<br>
            2. Jika muncul garis merah di pojok kiri atas,<br>berarti tangan terdeteksi.<br>
            3. Arahkan Pistol ke Zombie & Tembak.
        </p>
        <button class="btn-main" onclick="game.start()">DEPLOY</button>
    </div>

    <div id="game-over" class="screen" style="display:none;">
        <h1 style="color:red;">MISSION FAILED</h1>
        <p style="color:white;">KILLS: <span id="final-score">0</span></p>
        <button class="btn-main" onclick="location.reload()">RETRY</button>
    </div>

    <!-- AR SCENE -->
    <a-scene 
        vr-mode-ui="enabled: false" 
        renderer="logarithmicDepthBuffer: true; precision: high;" 
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        loading-screen="enabled: false">

        <a-assets>
            <a-asset-item id="titan-model" src="https://raw.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/CesiumMan/glTF-Binary/CesiumMan.glb"></a-asset-item>
        </a-assets>

        <a-light type="ambient" color="#fff" intensity="1.5"></a-light>
        <a-light type="directional" color="#fff" intensity="2" position="1 1 0"></a-light>

        <a-camera gps-camera rotation-reader far="5000">
            <!-- PISTOL 3D (Menempel di kamera dulu, nanti diupdate script) -->
            <a-entity id="gun-rig" position="0.5 -0.5 -1" rotation="0 0 0" visible="false">
                <a-entity scale="3 3 3" rotation="0 180 0">
                    <a-box color="#111" width="0.1" height="0.15" depth="0.4"></a-box>
                    <a-cylinder color="#333" radius="0.03" height="0.5" rotation="90 0 0" position="0 0.05 -0.2"></a-cylinder>
                    <a-box color="#0ff" width="0.11" height="0.02" depth="0.4" position="0 0.08 0" material="emissive:#0ff; emissiveIntensity:3"></a-box>
                    <a-box color="#222" width="0.08" height="0.2" depth="0.1" position="0 -0.15 0.15" rotation="-20 0 0"></a-box>
                    <a-cylinder color="red" opacity="0.5" radius="0.005" height="50" rotation="90 0 0" position="0 0.05 -25"></a-cylinder>
                    <a-sphere id="muzzle" color="orange" radius="0.2" position="0 0.05 -0.5" visible="false" material="emissive:orange; emissiveIntensity:5"></a-sphere>
                </a-entity>
            </a-entity>
        </a-camera>
    </a-scene>

    <script>
        // --- GAME CORE ---
        const game = {
            running: false,
            score: 0, wave: 1, hp: 100, ammo: 30,
            zombies: [],
            
            start: function() {
                document.getElementById('start-screen').style.display = 'none';
                this.running = true;
                ai.init();
                this.spawnWave();
                this.loop();
                
                const btn = document.getElementById('fire-btn');
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); this.shoot(); });
                btn.addEventListener('mousedown', (e) => { e.preventDefault(); this.shoot(); });
            },

            loop: function() {
                if(!this.running) return;
                requestAnimationFrame(() => this.loop());
                this.updateZombies();
                this.updateRadar();
            },

            spawnWave: function() {
                for(let i=0; i<2; i++) this.spawnZombie();
            },

            spawnZombie: function() {
                const scene = document.querySelector('a-scene');
                const el = document.createElement('a-entity');
                el.classList.add('zombie');
                
                const cam = document.querySelector('[gps-camera]').object3D;
                const angle = Math.random() * Math.PI * 2;
                const dist = 40 + Math.random() * 40; // Jauh
                const x = cam.position.x + Math.sin(angle) * dist;
                const z = cam.position.z + Math.cos(angle) * dist;

                el.setAttribute('position', `${x} -35 ${z}`);

                // Model
                const model = document.createElement('a-entity');
                model.setAttribute('gltf-model', '#titan-model');
                model.setAttribute('scale', '30 30 30');
                model.setAttribute('animation-mixer', 'clip: *; loop: repeat; timeScale: 1.5');
                el.appendChild(model);

                // HITBOX RAKSASA (Kunci agar gampang ditembak)
                const hitbox = document.createElement('a-box');
                hitbox.setAttribute('material', 'visible: false');
                hitbox.classList.add('hitbox'); 
                hitbox.setAttribute('scale', '15 60 15'); // Sangat Besar
                hitbox.setAttribute('position', '0 30 0');
                el.appendChild(hitbox);

                scene.appendChild(el);
                this.zombies.push(el);
            },

            updateZombies: function() {
                const cam = document.querySelector('[gps-camera]').object3D.position;
                this.zombies.forEach(z => {
                    if(z.dataset.dead === 'true') return;
                    const zPos = z.object3D.position;
                    const dx = zPos.x - cam.x;
                    const dz = zPos.z - cam.z;
                    const dist = Math.sqrt(dx*dx + dz*dz);

                    if(dist > 15) {
                        z.object3D.lookAt(cam.x, zPos.y, cam.z);
                        const dir = new THREE.Vector3(dx, 0, dz).normalize().negate();
                        z.object3D.position.addScaledVector(dir, 0.2);
                    }
                    if(dist < 15) this.takeDamage(0.5); // Damage per frame kecil
                });
            },

            shoot: function() {
                if(this.ammo <= 0) return;
                this.ammo--; 
                document.getElementById('ammo').innerText = this.ammo;

                // Recoil Visual
                const gun = document.getElementById('gun-rig');
                const muzzle = document.getElementById('muzzle');
                if(gun) {
                    gun.object3D.position.z += 0.2;
                    muzzle.setAttribute('visible', 'true');
                    setTimeout(() => {
                        gun.object3D.position.z -= 0.2;
                        muzzle.setAttribute('visible', 'false');
                    }, 50);
                }

                // --- RAYCASTER DARI KURSOR ---
                const raycaster = new THREE.Raycaster();
                const camObj = document.querySelector('[gps-camera]').object3D.children[0];
                
                let ndcX = 0, ndcY = 0;
                
                if(ai.detected) {
                    // Gunakan posisi AI (0..1) convert ke NDC (-1..1)
                    ndcX = (ai.x * 2) - 1;
                    ndcY = -(ai.y * 2) + 1;
                }

                raycaster.setFromCamera(new THREE.Vector2(ndcX, ndcY), camObj);
                
                const intersects = raycaster.intersectObjects(document.querySelector('a-scene').object3D.children, true);
                
                for(let hit of intersects) {
                    let el = hit.object.el;
                    // Cari parent zombie
                    while(el && !el.classList.contains('zombie')) {
                        el = el.parentNode;
                    }
                    if(el && el.dataset.dead !== 'true') {
                        this.killZombie(el);
                        break;
                    }
                }
            },

            killZombie: function(el) {
                el.dataset.dead = 'true';
                el.setAttribute('animation', 'property: rotation; to: -90 0 0; dur: 800');
                this.score++;
                document.getElementById('score').innerText = this.score;
                setTimeout(() => {
                    if(el.parentNode) el.parentNode.removeChild(el);
                    this.zombies = this.zombies.filter(z => z !== el);
                    if(this.zombies.length < 2) this.spawnZombie();
                }, 1000);
            },

            takeDamage: function(amt) {
                this.hp -= amt;
                if(this.hp < 0) this.hp = 0;
                document.getElementById('hp-bar').style.width = this.hp + "%";
                
                const flash = document.getElementById('damage-flash');
                flash.style.opacity = 0.8; 
                setTimeout(() => flash.style.opacity = 0, 100);

                if(this.hp <= 0) {
                    this.running = false;
                    document.getElementById('game-over').style.display = 'flex';
                    document.getElementById('final-score').innerText = this.score;
                }
            },

            updateRadar: function() {
                const radar = document.getElementById('radar');
                // Bersihkan blip
                Array.from(radar.children).forEach(c => { if(c.className === 'radar-blip') c.remove(); });
                
                const cam = document.querySelector('[gps-camera]').object3D;
                const angle = cam.rotation.y;

                this.zombies.forEach(z => {
                    if(z.dataset.dead === 'true') return;
                    const pos = z.object3D.position;
                    const dx = pos.x - cam.position.x;
                    const dz = pos.z - cam.position.z;
                    const rx = dx * Math.cos(angle) - dz * Math.sin(angle);
                    const rz = dx * Math.sin(angle) + dz * Math.cos(angle);
                    const px = 50 + (rx * 0.3);
                    const py = 50 + (rz * 0.3);
                    
                    if((px-50)**2 + (py-50)**2 < 50**2) {
                        const b = document.createElement('div');
                        b.className = 'radar-blip';
                        b.style.left = px + 'px'; b.style.top = py + 'px';
                        radar.appendChild(b);
                    }
                });
            }
        };

        // --- AI HAND TRACKING (ROBUST VERSION) ---
        const ai = {
            hands: null,
            video: null,
            detected: false,
            x: 0.5, y: 0.5,
            ctx: null, canvas: null,

            init: function() {
                // Setup Debug Canvas
                this.canvas = document.getElementById('debug-canvas');
                this.ctx = this.canvas.getContext('2d');

                this.hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                this.hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 0, // Lite
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                this.hands.onResults(this.onResults.bind(this));
                
                this.findVideoLoop();
            },

            findVideoLoop: function() {
                // Cari video AR.js secara agresif
                const v = document.querySelector('video');
                if(v && v.readyState >= 2 && v.videoWidth > 0) {
                    this.video = v;
                    console.log("Video Found!", v);
                    document.getElementById('status-msg').innerText = "AI CONNECTED. SHOW HAND.";
                    this.processLoop();
                } else {
                    setTimeout(() => this.findVideoLoop(), 500);
                }
            },

            processLoop: function() {
                if(!game.running) return;
                // Kirim frame ke MediaPipe
                this.hands.send({image: this.video}).then(() => {
                    requestAnimationFrame(() => this.processLoop());
                });
            },

            onResults: function(res) {
                const cursor = document.getElementById('aim-cursor');
                const status = document.getElementById('status-msg');
                const gun = document.getElementById('gun-rig');

                // Debug Draw
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                if(res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                    drawConnectors(this.ctx, res.multiHandLandmarks[0], HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                    drawLandmarks(this.ctx, res.multiHandLandmarks[0], {color: '#FF0000', lineWidth: 1});
                    
                    this.detected = true;
                    status.style.display = 'none';
                    cursor.style.opacity = 1;
                    if(gun) gun.setAttribute('visible', 'true');

                    const lm = res.multiHandLandmarks[0];
                    const index = lm[8]; // Telunjuk
                    const wrist = lm[0];

                    this.x = index.x;
                    this.y = index.y;

                    // Update UI Cursor
                    cursor.style.left = (this.x * 100) + '%';
                    cursor.style.top = (this.y * 100) + '%';

                    // Update Gun 3D Position
                    if(gun) {
                        // Mapping: (0..1) -> (-X..+X)
                        const gunX = (wrist.x - 0.5) * 3.0;
                        const gunY = -(wrist.y - 0.5) * 2.0 - 0.3;
                        gun.object3D.position.x = gunX;
                        gun.object3D.position.y = gunY;

                        // Rotasi mengikuti jari
                        const dx = index.x - wrist.x;
                        const dy = index.y - wrist.y;
                        const rotZ = Math.atan2(dy, dx) * (180/Math.PI) + 90;
                        
                        gun.object3D.rotation.z = THREE.Math.degToRad(rotZ);
                        gun.object3D.rotation.y = (index.x - 0.5) * -1.0;
                        gun.object3D.rotation.x = (index.y - 0.5) * 0.5;
                    }

                } else {
                    this.detected = false;
                    status.style.display = 'block';
                    status.innerText = "TANGAN HILANG!";
                    cursor.style.opacity = 0.2;
                }
            }
        };
    </script>
</body>
</html>
