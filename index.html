<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Bug Hunt ‚Äî A‚ÄëFrame + AR.js</title>
  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
  <style>
    :root { --pill: rgba(0,0,0,.60); --text:#fff; }
    html,body{ margin:0; height:100%; overflow:hidden; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .hud{ position:fixed; left:0; right:0; top:0; padding:10px 14px; display:flex; gap:8px; z-index:10; align-items:center; }
    .hud .pill{ background:var(--pill); color:var(--text); padding:6px 10px; border-radius:999px; font-size:12px; }
    .hud .right{ margin-left:auto; display:flex; gap:8px; }
    .footer{ position:fixed; left:0; right:0; bottom:0; padding:10px 14px; display:flex; justify-content:center; z-index:10; }
    .footer .pill{ background:var(--pill); color:var(--text); padding:6px 12px; border-radius:999px; font-size:13px; cursor:pointer; user-select:none; }
    .splash{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.65); color:#fff; z-index:20; }
    .card{ background:#111; padding:18px 20px; border-radius:16px; width:min(92%,540px); box-shadow:0 10px 30px rgba(0,0,0,.4); }
    .card h1{ margin:0 0 8px; font-size:20px; }
    .card p{ margin:6px 0; opacity:.9; font-size:14px; }
    .card .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center; }
    .btn{ background:#1e90ff; color:#fff; border:0; padding:10px 14px; border-radius:999px; font-weight:600; cursor:pointer; }
    a{ color:#9df }
    .hidden{ display:none }
  </style>
</head>
<body>
  <div id="splash" class="splash">
    <div class="card">
      <h1>üêû AR Bug Hunt</h1>
      <p>Tujuan: <b>Tap</b> serangga yang muncul di atas marker <b>HIRO</b> sebelum waktu habis.</p>
      <p>Tips: Jalankan via HTTPS dan pastikan kamera aktif. Cetak/lihat marker HIRO.</p>
      <div class="row"><a href="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/data/HIRO.jpg" target="_blank">Download Marker HIRO</a></div>
      <div class="row"><button id="btnStart" class="btn">Mulai Game</button></div>
      <p style="margin-top:10px; font-size:12px; opacity:.8">A‚ÄëFrame + AR.js single HTML ‚Äî tap serangga untuk skor, combo untuk bonus.</p>
    </div>
  </div>

  <div class="hud">
    <div class="pill">‚è±Ô∏è <span id="time">60</span>s</div>
    <div class="pill">üéØ Skor: <span id="score">0</span></div>
    <div class="pill">üî• Combo: <span id="combo">x1</span></div>
    <div class="right">
      <div class="pill">Marker: HIRO</div>
    </div>
  </div>
  <div class="footer">
    <div id="btnSpawn" class="pill">+ Spawn Manual</div>
  </div>

  <audio id="sndHit" preload="auto" src="https://cdn.jsdelivr.net/gh/terkelg/awesome-creative-audio@master/sounds/click-2.wav"></audio>
  <audio id="sndMiss" preload="auto" src="https://cdn.jsdelivr.net/gh/terkelg/awesome-creative-audio@master/sounds/click-8.wav"></audio>

  <script>
    // ===== Components =====
    // Random walker (hover + roam around center)
    AFRAME.registerComponent('bug', {
      schema: {
        speed: {type:'number', default: 0.6},   // movement
        flap:  {type:'number', default: 6},     // flap speed
        size:  {type:'number', default: 1.0},
        radius:{type:'number', default: 0.35},  // roam radius
        kind:  {type:'string', default:'butterfly'} // 'butterfly' | 'beetle'
      },
      init: function(){
        const s = this.data.size;
        const root = document.createElement('a-entity');
        this.el.appendChild(root);

        if(this.data.kind === 'butterfly'){
          // body
          const body = document.createElement('a-cylinder');
          body.setAttribute('radius', 0.02*s);
          body.setAttribute('height', 0.22*s);
          body.setAttribute('color', '#222');
          body.setAttribute('rotation','0 0 90');
          root.appendChild(body);
          // wing pivots
          const l = document.createElement('a-entity'); l.setAttribute('position', `${0.03*s} 0 0`); root.appendChild(l);
          const r = document.createElement('a-entity'); r.setAttribute('position', `${-0.03*s} 0 0`); root.appendChild(r);
          const lw = document.createElement('a-plane'); lw.setAttribute('width', 0.26*s); lw.setAttribute('height', 0.20*s); lw.setAttribute('material','opacity:0.95; side:double'); lw.setAttribute('color', '#ff7edb'); lw.setAttribute('position', `${0.13*s} 0 0`); l.appendChild(lw);
          const rw = document.createElement('a-plane'); rw.setAttribute('width', 0.26*s); rw.setAttribute('height', 0.20*s); rw.setAttribute('material','opacity:0.95; side:double'); rw.setAttribute('color', '#7ef9ff'); rw.setAttribute('position', `${-0.13*s} 0 0`); r.appendChild(rw);
          this.l = l; this.r = r; this.root = root; this.lw = lw; this.rw = rw;
        } else {
          const beetle = document.createElement('a-sphere');
          beetle.setAttribute('radius', 0.08*s); beetle.setAttribute('color','#1a1a1a');
          root.appendChild(beetle);
          const wing = document.createElement('a-torus'); wing.setAttribute('radius','0.10'); wing.setAttribute('radius-tubular','0.01'); wing.setAttribute('color','#2b2b2b'); wing.setAttribute('rotation','90 0 0'); root.appendChild(wing);
          this.root = root;
        }

        // marker disc under bug
        const ring = document.createElement('a-ring');
        ring.setAttribute('radius-inner','0.016');
        ring.setAttribute('radius-outer','0.036');
        ring.setAttribute('color','#ffc400');
        ring.setAttribute('rotation','-90 0 0');
        ring.setAttribute('position','0 0 0');
        this.el.appendChild(ring);

        // interaction collider
        this.el.classList.add('target');
        this.el.setAttribute('geometry','primitive: sphere; radius: 0.12');
        this.el.setAttribute('material','opacity:0; color:#fff');

        this.phase = Math.random()*Math.PI*2;
      },
      tick: function(time){
        const t = time/1000 + this.phase;
        // hover + roam circle
        const y = 0.08 + Math.sin(t*2)*0.03;
        const x = Math.cos(t*this.data.speed)*this.data.radius;
        const z = Math.sin(t*this.data.speed)*this.data.radius;
        this.el.setAttribute('position', `${x} ${y} ${z}`);
        // face forward
        const yaw = (Math.atan2(z,x)*180/Math.PI)+90; (this.root||this.el).setAttribute('rotation', `0 ${yaw} 0`);
        // wings
        if(this.l && this.r){
          const ang = Math.sin(t*this.data.flap)*35;
          this.l.setAttribute('rotation',`0 0 ${-ang}`);
          this.r.setAttribute('rotation',`0 0 ${ang}`);
        }
      }
    });

    // Simple pop animation when hit
    AFRAME.registerComponent('pop-on-hit',{
      init(){
        this.el.addEventListener('hit',()=>{
          const el = this.el;
          el.setAttribute('animation__scale', 'property: scale; to: 0.01 0.01 0.01; dur: 120; easing: easeInBack');
          setTimeout(()=> el.parentNode && el.parentNode.removeChild(el), 130);
        });
      }
    });

    // Raycaster from screen taps
    AFRAME.registerComponent('tap-shooter',{
      init(){
        const scene = this.el.sceneEl;
        scene.addEventListener('click', (e)=>{
          const raycaster = scene.components.raycaster || scene.querySelector('[raycaster]')?.components.raycaster;
          const camera = scene.camera.el;
          // Use A-Frame cursor/mouse raycaster
        });
      }
    });

    // ===== Game Manager =====
    const Game = {
      running:false,
      time:60,
      score:0,
      combo:1,
      spawnEach:1400,
      maxAlive:6,
      timerId:null,
      marker:null,
      sounds:{},
      ui:{time:null,score:null,combo:null},
      start(){
        this.running=true; this.time=60; this.score=0; this.combo=1; this.spawnEach=1200; this.maxAlive=6;
        this.ui.time.textContent=this.time; this.ui.score.textContent=this.score; this.ui.combo.textContent='x'+this.combo;
        // clear existing bugs
        [...this.marker.querySelectorAll('.target')].forEach(e=>e.parentNode.removeChild(e));
        // start timers
        this.timerId = setInterval(()=>{ this.time--; this.ui.time.textContent=this.time; if(this.time<=0) return this.end(); },1000);
        // auto spawn loop
        const loop = ()=>{
          if(!this.running) return;
          if(this.marker.querySelectorAll('.target').length < this.maxAlive){ this.spawn(); }
          setTimeout(loop, this.spawnEach);
        }; loop();
      },
      end(){
        this.running=false; clearInterval(this.timerId);
        alert('Game over! Skor: '+this.score);
      },
      spawn(){
        const e = document.createElement('a-entity');
        const kind = Math.random()<0.7? 'butterfly':'beetle';
        const speed = 0.5 + Math.random()*0.7;
        const radius= 0.18 + Math.random()*0.42;
        const size  = 0.9 + Math.random()*0.6;
        e.setAttribute('bug', `kind:${kind}; speed:${speed.toFixed(2)}; radius:${radius.toFixed(2)}; size:${size.toFixed(2)}`);
        e.setAttribute('pop-on-hit','');
        // clickable by cursor raycaster
        e.setAttribute('class','target');
        this.marker.appendChild(e);
      },
      hit(target){
        if(!this.running) return;
        this.score += 10 * this.combo; this.combo = Math.min(this.combo+1, 10);
        this.ui.score.textContent=this.score; this.ui.combo.textContent='x'+this.combo;
        // play sound & emit event for pop animation
        this.sounds.hit.currentTime=0; try{ this.sounds.hit.play(); }catch{}
        target.emit('hit');
      },
      miss(){
        if(!this.running) return;
        this.combo = 1; this.ui.combo.textContent='x'+this.combo;
        this.sounds.miss.currentTime=0; try{ this.sounds.miss.play(); }catch{}
      }
    };
  </script>

  <!-- ===== AR Scene ===== -->
  <a-scene
    id="scene"
    embedded
    renderer="antialias: true; alpha: true"
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false;">

    <!-- Lights -->
    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0 1 1"></a-entity>

    <!-- Marker -->
    <a-marker id="marker" type="pattern" url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/patt.hiro">
      <a-cylinder radius="0.4" height="0.01" color="#222" material="opacity:0.15" rotation="90 0 0"></a-cylinder>
      <!-- initial few bugs -->
      <a-entity bug="kind: butterfly; speed:0.7; radius:0.22" pop-on-hit class="target"></a-entity>
      <a-entity bug="kind: beetle; speed:0.6; radius:0.30" pop-on-hit class="target"></a-entity>
    </a-marker>

    <!-- Camera & cursor (mouse/touch ray) -->
    <a-entity camera look-controls="enabled:false"></a-entity>
    <a-entity id="cursor" cursor="rayOrigin: mouse" raycaster="objects: .target"></a-entity>
  </a-scene>

  <script>
    // Wire UI and scene after DOM ready
    const $ = sel => document.querySelector(sel);
    const scene = $('#scene');
    const marker = $('#marker');
    const cursor = $('#cursor');
    Game.marker = marker;
    Game.ui = { time: $('#time'), score: $('#score'), combo: $('#combo') };
    Game.sounds = { hit: $('#sndHit'), miss: $('#sndMiss') };

    // Tap / click handling using raycaster intersection
    let canInteract = true;
    scene.addEventListener('click', (ev)=>{
      if(!Game.running) return;
      const intersections = cursor.components.raycaster.intersections || [];
      const first = intersections[0]?.object?.el; // A-Frame entity
      if(first && first.classList.contains('target')){
        Game.hit(first);
      } else {
        Game.miss();
      }
    });

    // Buttons
    $('#btnStart').addEventListener('click', ()=>{
      // resume audio context on mobile
      try { const ctx = new (window.AudioContext||window.webkitAudioContext)(); ctx.resume(); } catch {}
      $('#splash').classList.add('hidden');
      Game.start();
    });
    $('#btnSpawn').addEventListener('click', ()=> Game.spawn());

    // Quality-of-life: pause combo if marker lost
    marker.addEventListener('markerLost', ()=>{ Game.combo = 1; Game.ui.combo.textContent='x1'; });
  </script>
</body>
</html>
