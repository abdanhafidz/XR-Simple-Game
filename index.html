<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Zombie Shooter â€“ Front Spawn</title>

    <!-- A-FRAME compatible with AR.js -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>

    <!-- AR.js Full (Camera-based AR, no GPS needed) -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: Arial; }
        #crosshair {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; height: 40px; z-index: 9999; pointer-events: none;
        }
        #crosshair div {
            position: absolute; background: red;
        }
        .h { width: 40px; height: 2px; top: 50%; }
        .v { width: 2px; height: 40px; left: 50%; }
        #info {
            position: fixed; bottom: 15px; left: 15px;
            background: rgba(0,0,0,.6); padding: 10px;
            color: #0f0; font-size: 14px; z-index: 9999;
            border-radius: 6px; font-family: monospace;
        }
    </style>
</head>

<body>

    <!-- CROSSHAIR -->
    <div id="crosshair">
        <div class="h"></div>
        <div class="v"></div>
    </div>

    <!-- INFO -->
    <div id="info">
        Kills: <span id="kills">0</span>
    </div>

    <!-- AR SCENE -->
    <a-scene
        embedded
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">

        <!-- Camera -->
        <a-entity id="camera" camera look-controls></a-entity>

    </a-scene>

<script>
let scene;
let camera;
let zombies = [];
let kills = 0;

// START WHEN DOM READY
document.addEventListener("DOMContentLoaded", () => {
    scene = document.querySelector("a-scene");
    camera = document.querySelector("#camera");

    if (!scene.hasLoaded) {
        scene.addEventListener("loaded", startGame);
    } else {
        startGame();
    }
});

function startGame() {
    console.log("Game started");
    spawnZombie();
}

/* CREATE ZOMBIE ENTITY */
function createZombie() {
    const z = document.createElement("a-entity");

    // Body
    const body = document.createElement("a-cylinder");
    body.setAttribute("color", "#3d5e3d");
    body.setAttribute("radius", "0.4");
    body.setAttribute("height", "1");
    body.setAttribute("position", "0 0.5 0");
    z.appendChild(body);

    // Head
    const head = document.createElement("a-sphere");
    head.setAttribute("color", "#6f8f6f");
    head.setAttribute("radius", "0.3");
    head.setAttribute("position", "0 1.2 0");
    z.appendChild(head);

    z.setAttribute("scale", "4 4 4");
    z.setAttribute("look-at", "#camera");

    z.userData = { health: 100, dead: false };

    return z;
}

/* SPAWN ZOMBIE DI DEPAN KAMERA */
function spawnZombie() {
    const z = createZombie();

    // ambil posisi kamera + arah
    const camPos = new THREE.Vector3();
    const camDir = new THREE.Vector3();

    camera.object3D.getWorldPosition(camPos);
    camera.object3D.getWorldDirection(camDir);

    const distance = 0.5; // 50cm

    const spawnPos = camPos.clone().add(camDir.multiplyScalar(distance));

    z.setAttribute("position",
        `${spawnPos.x} ${spawnPos.y - 1.0} ${spawnPos.z}`); // sedikit turun agar di lantai

    scene.appendChild(z);
    zombies.push(z);

    console.log("Zombie spawned FRONT at", spawnPos);
}

/* SHOOT EVENT */
document.addEventListener("click", () => {
    if (!camera) return;

    const camPos = new THREE.Vector3();
    const camDir = new THREE.Vector3();

    camera.object3D.getWorldPosition(camPos);
    camera.object3D.getWorldDirection(camDir);

    const ray = new THREE.Raycaster(camPos, camDir);

    let hit = null;
    let dist = Infinity;

    zombies.forEach(z => {
        if (z.userData.dead) return;

        const r = ray.intersectObject(z.object3D, true);
        if (r.length > 0 && r[0].distance < dist) {
            dist = r[0].distance;
            hit = z;
        }
    });

    if (hit) {
        hit.userData.health -= 50;

        if (hit.userData.health <= 0) {
            killZombie(hit);
        }
    }
});

/* KILL ZOMBIE */
function killZombie(z) {
    z.userData.dead = true;

    kills++;
    document.getElementById("kills").textContent = kills;

    let s = 4;
    const fade = setInterval(() => {
        s *= 0.85;
        z.setAttribute("scale", `${s} ${s} ${s}`);

        if (s < 0.2) {
            clearInterval(fade);
            if (z.parentNode) z.parentNode.removeChild(z);
            zombies = zombies.filter(e => e !== z);

            // spawn zombie baru
            setTimeout(() => spawnZombie(), 700);
        }
    }, 40);
}
</script>

</body>
</html>
