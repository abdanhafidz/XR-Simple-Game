<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Zombie Shooter AR</title>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
</head>
<body style="margin:0; overflow:hidden;">
<a-scene
  renderer="colorManagement: true"
  xr-mode-ui="enabled: true"
  webxr="overlayElement: #overlay; optionalFeatures: hit-test; requiredFeatures: hit-test;"
  vr-mode-ui="enabled: false"
  cursor="rayOrigin: mouse"
  id="scene">

  <a-entity id="camera" camera look-controls position="0 1.6 0"></a-entity>

  <!-- Crosshair -->
  <a-entity position="0 0 -1" id="crosshair"
            geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
            material="color: red; shader: flat"
            camera>
  </a-entity>

  <!-- Zombie Template -->
  <a-asset-item id="zombieGLB" src="https://models.readyplayer.me/63cfe8d6c3c9a465b236a225.glb"></a-asset-item>

  <a-entity id="zombieContainer"></a-entity>

  <!-- Placement cursor -->
  <a-entity id="cursor" visible="false">
    <a-sphere radius="0.03" color="yellow"></a-sphere>
  </a-entity>

</a-scene>

<div id="overlay" style="position:fixed;top:0;left:0;right:0;padding:12px;color:white;z-index:10;font-family:sans-serif;background:rgba(0,0,0,.4)">
  <div>ðŸ§Ÿ Zombie Shooter AR</div>
  <div>Tap lantai untuk spawn zombie</div>
  <div>Tap zombie untuk tembak ðŸŽ¯</div>
  <div id="score">Score: 0</div>
</div>

<script>
let score = 0;
const scoreEl = document.getElementById("score");
const scene = document.querySelector("#scene");
const container = document.querySelector("#zombieContainer");
let hitTestSource = null, localSpace = null;
let cursor = document.querySelector("#cursor");

AFRAME.registerComponent("zombie", {
  tick: function () {
    const z = this.el.object3D;
    const playerPos = new THREE.Vector3();
    scene.camera.getWorldPosition(playerPos);

    const dir = playerPos.clone().sub(z.position).normalize();
    z.position.add(dir.multiplyScalar(0.01)); // zombie move speed

    if (z.position.distanceTo(playerPos) < 0.5) {
      alert("ðŸ’€ Game Over! Zombies got you!");
      window.location.reload();
    }
  }
});

scene.addEventListener("enter-vr", async () => {
  const session = scene.renderer.xr.getSession();
  const viewerSpace = await session.requestReferenceSpace('viewer');
  hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
  localSpace = await session.requestReferenceSpace('local');

  session.addEventListener("end", () => { hitTestSource = null; });
});

scene.renderer.xr.addEventListener("update", (ev) => {
  if (!hitTestSource) return;

  const frame = scene.frame;
  const viewerPose = frame.getViewerPose(localSpace);
  if (!viewerPose) return;

  const hit = frame.getHitTestResults(hitTestSource)[0];
  if (hit) {
    const pose = hit.getPose(localSpace);
    cursor.object3D.position.copy(pose.transform.position);
    cursor.object3D.visible = true;
  }
});

scene.addEventListener("click", () => {
  // check if clicked zombie
  const raycaster = scene.components.raycaster.raycaster;
  const hits = raycaster.intersectObjects(container.object3D.children);

  if (hits.length) {
    const zombie = hits[0].object.el;
    zombie.parentNode.removeChild(zombie);
    score++;
    scoreEl.innerText = "Score: " + score;
    return;
  }

  // spawn new zombie at cursor
  if (cursor.object3D.visible) {
    const z = document.createElement("a-entity");
    z.setAttribute("gltf-model", "#zombieGLB");
    z.setAttribute("zombie", "");
    z.setAttribute("scale", "0.8 0.8 0.8");
    z.object3D.position.copy(cursor.object3D.position);
    container.appendChild(z);
  }
});
</script>
</body>
</html>
