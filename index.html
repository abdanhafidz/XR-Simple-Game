<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <!-- Viewport Fix: viewport-fit=cover penting untuk HP layar poni/notch -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Zombie Shooter: Apocalypse</title>
    
    <!-- Libraries -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* FIX LAYOUT HITAM DI KANAN */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            position: fixed; /* Kunci layar agar tidak bisa digeser */
        }

        /* Paksa Canvas A-Frame Fullscreen */
        .a-canvas {
            width: 100% !important;
            height: 100% !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            position: fixed !important;
            z-index: 0 !important;
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute; /* Ganti fixed ke absolute agar ikut flow body */
            top: 0; left: 0; 
            width: 100vw; /* Gunakan Viewport Width */
            height: 100vh; /* Gunakan Viewport Height */
            pointer-events: none; 
            z-index: 100;
            display: flex; flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
        }

        /* --- RADAR UI --- */
        .radar-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 100px; /* Sedikit dikecilkan agar muat */
            height: 100px;
            background: rgba(0, 20, 0, 0.7);
            border: 2px solid #0f0;
            border-radius: 50%;
            pointer-events: none;
            overflow: hidden;
            z-index: 150;
            box-shadow: 0 0 10px #0f0, inset 0 0 20px rgba(0, 255, 0, 0.5);
        }

        .radar-sweep {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0, 255, 0, 0.4) 30deg, transparent 30.1deg);
            animation: radarSpin 2s linear infinite;
            z-index: 1;
        }

        .radar-center {
            position: absolute; top: 50%; left: 50%;
            width: 4px; height: 4px; background: #fff;
            border-radius: 50%; transform: translate(-50%, -50%);
            z-index: 3; box-shadow: 0 0 4px #fff;
        }

        .radar-blip {
            position: absolute; width: 6px; height: 6px;
            background: #ff0000; border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 2;
            box-shadow: 0 0 4px #f00; transition: top 0.2s, left 0.2s;
        }

        @keyframes radarSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* HUD Panels */
        .hud-top {
            display: flex; justify-content: space-between;
            padding: 15px; width: 100%; box-sizing: border-box;
        }

        .hud-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(4px);
            padding: 5px 12px;
            transform: skewX(-10deg);
            display: flex; flex-direction: column; align-items: center; min-width: 70px;
        }

        .score-box { border-left: 3px solid #0ff; }
        .wave-box { border-right: 3px solid #fa0; }
        .ammo-box { border-right: 4px solid #f00; padding: 10px 20px; background: rgba(0,0,0,0.7); }
        .ammo-wrapper { position: absolute; bottom: 30px; right: 20px; text-align: right; }
        
        .hud-label { font-size: 9px; color: #aaa; letter-spacing: 1px; }
        .hud-value { font-size: 18px; color: #fff; font-weight: bold; font-family: 'Share Tech Mono', monospace; }

        .crosshair-container {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.8;
        }
        .crosshair { width: 30px; height: 30px; border: 2px solid #0ff; border-radius: 50%; }
        .crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 4px; height: 4px; background: red;
            transform: translate(-50%, -50%); border-radius: 50%;
        }

        /* Screens */
        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.92);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 999; pointer-events: auto; text-align: center; padding: 20px;
        }

        .btn {
            background: linear-gradient(45deg, #cc0000, #990000);
            color: white; padding: 12px 30px; border: none;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            margin-bottom: 10px; cursor: pointer;
        }
        
        .btn-debug { background: #333; font-size: 10px; border: 1px solid #555; }

        .loader {
            border: 4px solid #333; border-top: 4px solid #0ff;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #debug-console {
            position: fixed; top: 0; left: 0; width: 100%; height: 120px;
            background: rgba(0,0,0,0.8); color: lime; font-size: 10px;
            z-index: 9999; overflow-y: scroll; pointer-events: auto; display: none; padding: 5px;
        }
    </style>
</head>

<body>
    <div id="debug-console">
        <div style="color:yellow; border-bottom:1px solid #555;">SYSTEM LOGS (DEBUG)</div>
    </div>

    <!-- UI Overlay -->
    <div id="ui-layer">
        <div class="hud-top">
            <div class="hud-panel score-box">
                <div class="hud-label">KILLS</div>
                <div class="hud-value" id="score">0</div>
            </div>
            
            <div class="hud-panel wave-box">
                <div class="hud-label">WAVE</div>
                <div class="hud-value" id="wave">1</div>
            </div>
        </div>

        <div class="crosshair-container">
            <div class="crosshair"></div>
        </div>

        <div class="radar-container" id="radar">
            <div class="radar-sweep"></div>
            <div class="radar-center"></div>
        </div>

        <div class="ammo-wrapper">
            <div class="hud-panel ammo-box">
                <div class="hud-label">AMMO</div>
                <div class="hud-value" style="font-size: 24px; color: #f00;"><span id="ammo">25</span></div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="fullscreen-overlay">
        <h1 style="color:red; font-size:24px;">ZOMBIE PROTOCOL</h1>
        <p style="color:#ccc; margin-bottom:20px;">
            Pastikan Anda di area terbuka.<br>
            Izinkan akses Kamera & Lokasi.
        </p>
        <button class="btn" id="start-btn">START MISSION</button>
        <button class="btn btn-debug" onclick="toggleDebug()">DEBUG MENU</button>
        
        <!-- PENTING: Tombol Force Spawn untuk testing indoor -->
        <button class="btn btn-debug" id="force-spawn-btn" style="color: yellow; border-color: yellow; margin-top: 10px;">
            ⚠️ FORCE SPAWN (TESTING)
        </button>
        
        <div style="font-size:10px; color:#666; margin-top:10px;">V3.0: Fullscreen Fix + Fallback Box</div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fullscreen-overlay" style="display: none;">
        <div class="loader"></div>
        <p>Mencari Sinyal GPS...</p>
        <div id="gps-info" style="font-size:10px; color:#aaa;">Waiting...</div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="fullscreen-overlay" style="display: none;">
        <h1 style="color:red;">M.I.A.</h1>
        <p>Kills: <span id="final-score" style="color: #0ff;">0</span></p>
        <button class="btn" id="restart-btn">RETRY</button>
    </div>

    <!-- AR SCENE -->
    <a-scene
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        arjs='sourceType: webcam; videoTexture: false; debugUIEnabled: false;'
        loading-screen="dotsColor: red; backgroundColor: black">
        
        <a-assets timeout="30000">
            <!-- Model Monster -->
            <a-asset-item id="monster-model" src="https://raw.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/Monster/glTF-Binary/Monster.glb"></a-asset-item>
        </a-assets>

        <a-light type="ambient" color="#ffffff" intensity="1.0"></a-light>
        <a-light type="directional" color="#ffffff" intensity="1.5" position="-1 1 0"></a-light>

        <a-camera gps-camera rotation-reader far="1000"></a-camera>
    </a-scene>

    <script>
        // --- LOGGER ---
        const debugConsole = document.getElementById('debug-console');
        function log(msg) {
            console.log(msg);
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            debugConsole.appendChild(div);
            debugConsole.scrollTop = debugConsole.scrollHeight;
        }
        function toggleDebug() {
            debugConsole.style.display = debugConsole.style.display === 'none' ? 'block' : 'none';
        }

        // --- CONFIG ---
        const CONFIG = {
            maxZombies: 5,
            spawnRadiusMin: 3, 
            spawnRadiusMax: 6,
            startAmmo: 25,
            modelScale: 0.04,
            radarRange: 20
        };

        let state = {
            score: 0,
            ammo: CONFIG.startAmmo,
            wave: 1,
            zombies: [],
            isGameRunning: false,
            userLocation: null
        };

        const ui = {
            radar: document.getElementById('radar'),
            score: document.getElementById('score'),
            ammo: document.getElementById('ammo'),
            wave: document.getElementById('wave'),
            startScreen: document.getElementById('start-screen'),
            loadingScreen: document.getElementById('loading-screen'),
            gpsInfo: document.getElementById('gps-info'),
            gameOverScreen: document.getElementById('game-over-screen'),
            scene: document.querySelector('a-scene')
        };

        // --- RADAR ---
        function updateRadar() {
            if (!state.isGameRunning) return;

            // Clear old blips
            document.querySelectorAll('.radar-blip').forEach(b => b.remove());

            const cameraEl = document.querySelector('[gps-camera]');
            if (!cameraEl) return;
            
            const camY = cameraEl.getAttribute('rotation').y; 
            const userRad = THREE.Math.degToRad(camY);

            state.zombies.forEach(zombie => {
                let dist = 0;
                let bearing = 0;

                // Hitung posisi berdasarkan tipe zombie (GPS vs Lokal)
                if (zombie.getAttribute('gps-entity-place')) {
                    // Logic GPS (Outdoor)
                    if (!state.userLocation) return;
                    const zLat = parseFloat(zombie.components['gps-entity-place'].attrValue.latitude);
                    const zLng = parseFloat(zombie.components['gps-entity-place'].attrValue.longitude);
                    
                    const R = 6371e3;
                    const φ1 = state.userLocation.latitude * Math.PI/180;
                    const φ2 = zLat * Math.PI/180;
                    const Δφ = (zLat-state.userLocation.latitude) * Math.PI/180;
                    const Δλ = (zLng-state.userLocation.longitude) * Math.PI/180;

                    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                            Math.cos(φ1) * Math.cos(φ2) *
                            Math.sin(Δλ/2) * Math.sin(Δλ/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    dist = R * c;

                    const y = Math.sin(Δλ) * Math.cos(φ2);
                    const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
                    bearing = Math.atan2(y, x);
                } else {
                    // Logic Lokal (Force Spawn / Indoor)
                    const pos = zombie.object3D.position; // Vector3
                    dist = Math.sqrt(pos.x*pos.x + pos.z*pos.z);
                    bearing = Math.atan2(pos.x, pos.z); // Simple atan2 for local
                }

                if (dist > CONFIG.radarRange) return;

                const relativeAngle = bearing - userRad;
                const uiRadius = (dist / CONFIG.radarRange) * 45; // 45px radius
                
                const blipX = 50 + Math.sin(relativeAngle) * uiRadius;
                const blipY = 50 - Math.cos(relativeAngle) * uiRadius;

                const blip = document.createElement('div');
                blip.className = 'radar-blip';
                blip.style.left = `${blipX}px`;
                blip.style.top = `${blipY}px`;
                ui.radar.appendChild(blip);
            });
        }
        setInterval(updateRadar, 200);

        // --- SHOOTING ---
        const raycaster = new THREE.Raycaster();
        const centerScreen = new THREE.Vector2(0, 0);

        function shoot() {
            if (!state.isGameRunning || state.ammo <= 0) return;

            state.ammo--;
            updateHUD();

            const crosshair = document.querySelector('.crosshair');
            crosshair.style.transform = "scale(1.5)";
            setTimeout(() => crosshair.style.transform = "scale(1)", 100);

            const cameraEl = document.querySelector('[gps-camera]');
            if(!cameraEl || !cameraEl.object3D) return;
            
            raycaster.setFromCamera(centerScreen, cameraEl.object3D.children[0]);
            
            const zombieMeshes = [];
            state.zombies.forEach(z => { if(z.object3D) zombieMeshes.push(z.object3D); });

            const intersects = raycaster.intersectObjects(zombieMeshes, true);

            if (intersects.length > 0) {
                let entity = intersects[0].object.el;
                while(entity && (!entity.classList || !entity.classList.contains('zombie'))) {
                    entity = entity.parentNode;
                    if(!entity) break;
                }

                if (entity && entity.classList.contains('zombie')) {
                    hitZombie(entity);
                }
            }
            
            if (state.ammo === 0 && state.zombies.length > 0) setTimeout(checkGameOver, 1000);
        }

        function hitZombie(entity) {
            if (entity.dataset.dead === "true") return;
            entity.dataset.dead = "true";
            
            log("HIT CONFIRMED!");
            
            const marker = document.createElement('div');
            marker.innerText = "HIT";
            marker.style.cssText = "position:absolute; top:45%; left:50%; transform:translate(-50%,-50%); color:red; font-weight:900; font-size:30px; animation: floatUp 0.5s forwards; text-shadow:0 0 5px #000; pointer-events:none; z-index:200;";
            document.body.appendChild(marker);
            setTimeout(() => marker.remove(), 500);

            entity.setAttribute('animation', { property: 'scale', to: '0 0 0', dur: 400, easing: 'easeInBack' });

            setTimeout(() => {
                if (entity.parentNode) entity.parentNode.removeChild(entity);
                state.zombies = state.zombies.filter(z => z !== entity);
                state.score++;
                updateHUD();
                if (state.zombies.length === 0) startNextWave();
            }, 400);
        }

        // --- SPAWNING ---
        function createZombieEntity() {
            const zombie = document.createElement('a-entity');
            zombie.classList.add('zombie');
            
            // 1. Model Wrapper
            const modelWrapper = document.createElement('a-entity');
            modelWrapper.setAttribute('position', '0 -1.6 0'); 
            modelWrapper.setAttribute('gltf-model', '#monster-model');
            modelWrapper.setAttribute('scale', `${CONFIG.modelScale} ${CONFIG.modelScale} ${CONFIG.modelScale}`);
            modelWrapper.setAttribute('animation-mixer', 'clip: *; loop: repeat; timeScale: 1');
            
            zombie.appendChild(modelWrapper);

            // 2. FALLBACK BOX (Penting jika model gagal load)
            // Kotak merah transparan ini akan muncul jika model GLTF gagal dirender
            const fallbackBox = document.createElement('a-box');
            fallbackBox.setAttribute('color', 'red');
            fallbackBox.setAttribute('opacity', '0.5');
            fallbackBox.setAttribute('width', '1');
            fallbackBox.setAttribute('height', '2');
            fallbackBox.setAttribute('depth', '1');
            fallbackBox.setAttribute('position', '0 0 0');
            fallbackBox.setAttribute('material', 'wireframe: true'); 
            // Kita sembunyikan dulu, tampilkan kalau error atau lewat debug
            // Tapi untuk testing sekarang kita biarkan saja menumpuk agar terlihat
            zombie.appendChild(fallbackBox);

            zombie.addEventListener('model-error', (e) => {
                log("GLTF ERROR. Using Fallback.");
                fallbackBox.setAttribute('material', 'wireframe: false; opacity: 0.8');
            });
            zombie.addEventListener('model-loaded', () => {
                log("GLTF Loaded Success");
                fallbackBox.setAttribute('visible', 'false'); // Sembunyikan kotak merah jika model sukses
            });

            return zombie;
        }

        function spawnZombieGPS() {
            if (!state.userLocation) return;
            const zombie = createZombieEntity();
            
            const angle = Math.random() * Math.PI * 2;
            const distance = CONFIG.spawnRadiusMin + Math.random() * (CONFIG.spawnRadiusMax - CONFIG.spawnRadiusMin);
            const latOffset = (Math.cos(angle) * distance) / 111111;
            const lngOffset = (Math.sin(angle) * distance) / (111111 * Math.cos(state.userLocation.latitude * Math.PI / 180));
            const lat = state.userLocation.latitude + latOffset;
            const lng = state.userLocation.longitude + lngOffset;

            zombie.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng}`);
            zombie.setAttribute('look-at', '[gps-camera]');

            ui.scene.appendChild(zombie);
            state.zombies.push(zombie);
            log(`Spawn GPS: ${distance.toFixed(1)}m`);
        }

        function spawnZombieLocal() {
            // Untuk testing indoor / force spawn
            const zombie = createZombieEntity();
            
            // Spawn 4 meter di depan (-Z) kamera
            // Kita harus mengambil posisi kamera saat ini, tapi karena relative to camera bisa tricky di AR
            // Kita tempelkan saja ke scene dengan posisi world
            // AR.js menggerakkan kamera, scene diam di 0,0,0 (start point)
            
            // Kita random posisi X dan Z di sekitar 0,0,0
            const angle = Math.random() * Math.PI * 2;
            const dist = 3; // 3 meter
            const x = Math.sin(angle) * dist;
            const z = Math.cos(angle) * dist;

            zombie.setAttribute('position', `${x} 0 ${z}`);
            zombie.setAttribute('look-at', '[gps-camera]');
            
            ui.scene.appendChild(zombie);
            state.zombies.push(zombie);
            log(`Spawn Local (Force): ${dist}m`);
        }

        function startNextWave() {
            state.wave++;
            state.ammo += 10;
            updateHUD();
            
            const msg = document.createElement('div');
            msg.innerText = `WAVE ${state.wave}`;
            msg.style.cssText = "position:fixed; top:40%; width:100%; text-align:center; color:orange; font-size:40px; font-weight:bold; z-index:90; text-shadow:2px 2px 0 #000;";
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 2500);

            const count = Math.min(state.wave + 1, CONFIG.maxZombies);
            for(let i=0; i<count; i++) {
                // Default ke GPS spawn
                setTimeout(spawnZombieGPS, i * 1500);
            }
        }

        function checkGameOver() {
            if (state.ammo <= 0 && state.zombies.length > 0) {
                state.isGameRunning = false;
                document.getElementById('final-score').innerText = state.score;
                ui.gameOverScreen.style.display = 'flex';
            }
        }

        function updateHUD() {
            ui.score.innerText = state.score;
            ui.ammo.innerText = state.ammo;
            ui.wave.innerText = state.wave;
        }

        // --- INIT ---
        function initGame(position) {
            state.userLocation = position.coords;
            state.isGameRunning = true;
            ui.loadingScreen.style.display = 'none';
            ui.startScreen.style.display = 'none'; // Pastikan start screen hilang
            
            window.addEventListener('click', shoot);
            window.addEventListener('touchstart', (e) => { shoot(); }, {passive: false});

            startNextWave();
        }

        document.getElementById('start-btn').addEventListener('click', () => {
            ui.startScreen.style.display = 'none';
            ui.loadingScreen.style.display = 'flex';
            log("Meminta Izin GPS...");

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    initGame,
                    (err) => {
                        alert("GPS Error: " + err.message);
                        ui.loadingScreen.style.display = 'none';
                        ui.startScreen.style.display = 'flex';
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 }
                );
            } else {
                alert("Browser tidak support Geolocation");
            }
        });

        // FORCE SPAWN BUTTON
        document.getElementById('force-spawn-btn').addEventListener('click', () => {
            log("Force Spawn Triggered");
            ui.startScreen.style.display = 'none'; // Sembunyikan menu
            state.isGameRunning = true; // Mulai game paksa
            spawnZombieLocal(); // Spawn zombie di depan muka
        });

        document.getElementById('restart-btn').addEventListener('click', () => location.reload());
        
        // Debug
        window.addEventListener('camera-error', (e) => log("Cam Error: " + e));
        window.addEventListener('gps-camera-update-position', (e) => {
            ui.gpsInfo.innerText = `GPS: ${e.detail.position.latitude.toFixed(5)}, ${e.detail.position.longitude.toFixed(5)}`;
        });
    </script>
</body>
</html>
