<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Zombie Shooter: Cyberpunk Edition</title>
    
    <!-- Libraries -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* RESET */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        
        #arjs-video, video {
            width: 100% !important; height: 100% !important;
            top: 0 !important; left: 0 !important;
            z-index: -2 !important; object-fit: cover !important;
            margin: 0 !important; position: absolute !important;
        }

        /* UI LAYER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 999;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* Damage Overlay */
        #damage-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 30%, rgba(255, 0, 0, 0.9) 100%);
            opacity: 0; transition: opacity 0.1s; pointer-events: none; z-index: 900;
            mix-blend-mode: overlay;
        }

        /* HUD STYLES */
        .hud-top { 
            display: flex; justify-content: space-between; padding: 20px; 
            padding-top: max(20px, env(safe-area-inset-top));
        }
        
        .hud-panel {
            background: rgba(0, 15, 30, 0.85);
            border: 1px solid rgba(0, 255, 255, 0.6);
            padding: 10px 25px;
            transform: skewX(-15deg);
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }

        .hud-content { transform: skewX(15deg); text-align: center; }

        .hud-label { 
            font-family: 'Share Tech Mono', monospace; font-size: 10px; 
            color: #00ffff; letter-spacing: 2px; text-shadow: 0 0 5px #00ffff;
        }
        
        .hud-value { 
            font-family: 'Orbitron', sans-serif; font-size: 28px; 
            color: #fff; font-weight: 900; text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }

        .panel-kills { border-left: 5px solid #00ffff; }
        .panel-wave { border-right: 5px solid #ffaa00; }
        .panel-wave .hud-label { color: #ffaa00; text-shadow: 0 0 5px #ffaa00; }
        .panel-wave .hud-value { color: #ffaa00; }

        /* BOTTOM HUD */
        .hud-bottom {
            display: flex; align-items: flex-end; justify-content: space-between; 
            padding: 20px; padding-bottom: max(30px, env(safe-area-inset-bottom));
        }

        /* HEALTH BAR */
        .health-container { width: 200px; transform: skewX(-15deg); }
        .health-bar-bg { 
            width: 100%; height: 15px; background: rgba(50, 0, 0, 0.8); 
            border: 2px solid #ff0000; box-shadow: 0 0 10px #ff0000;
        }
        .health-bar-fill { 
            width: 100%; height: 100%; background: #ff0000; 
            box-shadow: inset 0 0 10px #500; transition: width 0.2s;
        }
        .health-label { 
            color: #fff; font-family: 'Orbitron'; font-size: 12px; 
            margin-bottom: 5px; text-shadow: 0 0 5px #ff0000; transform: skewX(15deg);
        }

        /* AMMO */
        .panel-ammo { 
            border-right: 5px solid #ff0000; background: rgba(20, 0, 0, 0.85); 
            border-color: rgba(255, 0, 0, 0.6);
        }
        .panel-ammo .hud-label { color: #ff5555; text-shadow: 0 0 5px #ff0000; }
        .panel-ammo .hud-value { color: #ff0000; font-size: 36px; }

        /* CURSOR & HAND STATUS */
        .crosshair {
            position: absolute; width: 60px; height: 60px; 
            border: 2px dashed #0f0; border-radius: 50%;
            transform: translate(-50%, -50%); 
            opacity: 0; /* Muncul kalau tangan ada */
            box-shadow: 0 0 20px #0f0; pointer-events: none;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.2s;
        }
        .crosshair.active { opacity: 1; }
        .crosshair::after { 
            content: ''; width: 10px; height: 10px; 
            background: #0f0; border-radius: 50%; 
            box-shadow: 0 0 10px #fff;
        }

        #hand-status {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Share Tech Mono'; color: rgba(0, 255, 255, 0.8); font-size: 12px;
            text-align: center; text-shadow: 0 0 5px #000; pointer-events: none;
            background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px;
        }

        /* RADAR */
        .radar-box {
            position: absolute; bottom: 100px; left: 20px;
            width: 100px; height: 100px; border: 2px solid #0f0; border-radius: 50%;
            background: rgba(0, 20, 0, 0.8); overflow: hidden;
            box-shadow: 0 0 10px #0f0; pointer-events: auto;
        }
        .radar-center { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #fff; transform: translate(-50%, -50%); border-radius: 50%; }
        .radar-blip { position: absolute; width: 6px; height: 6px; background: red; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 4px #fff; }

        /* BUTTONS */
        #fire-btn {
            position: absolute; bottom: 120px; right: 30px;
            width: 90px; height: 90px; border-radius: 50%;
            background: rgba(255, 0, 0, 0.3); border: 3px solid #ff0000;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron'; color: white; font-weight: bold; font-size: 16px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); pointer-events: auto; z-index: 1000;
        }
        #fire-btn:active { background: rgba(255, 0, 0, 0.8); transform: scale(0.95); }

        /* SCREENS */
        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; pointer-events: auto;
        }
        .btn-start {
            background: linear-gradient(45deg, #cc0000, #990000);
            color: #fff; padding: 15px 40px; border: none;
            font-family: 'Orbitron'; font-weight: 900; font-size: 20px;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            letter-spacing: 2px; cursor: pointer; margin-top: 20px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
        }
    </style>
</head>

<body>
    <div id="damage-flash"></div>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="hud-panel panel-kills">
                <div class="hud-content">
                    <div class="hud-label">KILLS</div>
                    <div class="hud-value" id="score">0</div>
                </div>
            </div>
            <div class="hud-panel panel-wave">
                <div class="hud-content">
                    <div class="hud-label">WAVE</div>
                    <div class="hud-value" id="wave">1</div>
                </div>
            </div>
        </div>

        <!-- Cursor Hijau -->
        <div class="crosshair" id="finger-cursor"></div>
        <div id="hand-status">LOADING AI...<br>Arahkan Jari Telunjuk</div>
        
        <div class="radar-box" id="radar"><div class="radar-center"></div></div>
        <div id="fire-btn">SHOOT</div>

        <div class="hud-bottom">
            <div class="health-container">
                <div class="health-label">HP INTEGRITY</div>
                <div class="health-bar-bg"><div class="health-bar-fill" id="hp-bar"></div></div>
            </div>
            <div class="hud-panel panel-ammo">
                <div class="hud-content">
                    <div class="hud-label">AMMO</div>
                    <div class="hud-value" id="ammo">25</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="fullscreen-overlay">
        <h1 style="font-family:'Orbitron'; color:red; font-size: 40px; text-shadow: 0 0 20px red;">ZOMBIE PROTOCOL</h1>
        <p style="color:#aaa; font-family:'Share Tech Mono'; margin-bottom: 30px;">
            [ HAND TRACKING AIM ]<br>
            1. PISTOL IKUT TANGAN<br>
            2. KURSOR HIJAU = TITIK TEMBAK<br>
            3. TAP LAYAR UNTUK MENEMBAK
        </p>
        <button class="btn-start" onclick="startGame()">INITIATE</button>
    </div>

    <div id="game-over-screen" class="fullscreen-overlay" style="display: none;">
        <h1 style="font-family:'Orbitron'; color:red; font-size: 40px;">FATAL ERROR</h1>
        <p style="color:white; margin-bottom: 20px;">OPERATOR KILLED IN ACTION</p>
        <button class="btn-start" onclick="location.reload()">REBOOT SYSTEM</button>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: high;"
        arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'
        loading-screen="enabled: false">

        <a-assets>
            <a-asset-item id="titan-model" src="https://raw.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/CesiumMan/glTF-Binary/CesiumMan.glb"></a-asset-item>
        </a-assets>

        <a-light type="ambient" color="#fff" intensity="1.5"></a-light>
        <a-light type="directional" color="#fff" intensity="2" position="1 1 0"></a-light>

        <a-camera gps-camera rotation-reader far="5000">
            <!-- PISTOL 3D (Cosmetic) -->
            <!-- Mengikuti tangan via script -->
            <a-entity id="player-gun" position="0.3 -0.4 -0.8" rotation="0 0 0" scale="3 3 3" visible="false">
                <a-box color="#111" width="0.08" height="0.12" depth="0.3" position="0 0 0"></a-box>
                <a-cylinder color="#333" radius="0.03" height="0.4" rotation="90 0 0" position="0 0.05 -0.2"></a-cylinder>
                <a-box color="#0ff" width="0.09" height="0.02" depth="0.3" position="0 0.07 0" material="emissive: #0ff; emissiveIntensity: 3"></a-box>
                <a-box color="#222" width="0.06" height="0.15" depth="0.08" position="0 -0.1 0.1" rotation="-20 0 0"></a-box>
                <!-- Laser Merah dari Pistol -->
                <a-cylinder color="red" radius="0.002" height="50" rotation="90 0 0" position="0 0.05 -25" opacity="0.6" material="emissive: red; emissiveIntensity: 1"></a-cylinder>
                <a-sphere id="muzzle-flash" color="orange" radius="0.15" position="0 0.05 -0.5" visible="false" material="emissive: orange; emissiveIntensity: 5"></a-sphere>
            </a-entity>
        </a-camera>
    </a-scene>

    <script>
        // CONFIG
        const CONFIG = {
            spawnDistMin: 60, spawnDistMax: 100, 
            modelScale: 30, yOffset: -35, // Titan Settings
            radarScale: 0.3,
            damageDistance: 10.0,
            damageAmount: 10,
            startAmmo: 30,
            gunSensitivityX: 4.0,
            gunSensitivityY: 3.0
        };

        let gameState = { running: false, score: 0, wave: 1, zombies: [], hp: 100, ammo: CONFIG.startAmmo };
        let handData = { x: 0.5, y: 0.5, detected: false };

        // --- HAND TRACKING ---
        let hands;
        function setupMediaPipe() {
            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            hands.onResults(onHandResults);
        }

        function onHandResults(results) {
            const cursor = document.getElementById('finger-cursor');
            const status = document.getElementById('hand-status');
            const gun = document.getElementById('player-gun');

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                handData.detected = true;
                status.style.display = 'none';
                cursor.classList.add('active');
                if(gun) gun.setAttribute('visible', 'true');

                const landmarks = results.multiHandLandmarks[0];
                const indexTip = landmarks[8]; 
                const wrist = landmarks[0]; 
                
                handData.x = indexTip.x;
                handData.y = indexTip.y;

                // Update Kursor Hijau 2D
                cursor.style.left = `${indexTip.x * 100}%`;
                cursor.style.top = `${indexTip.y * 100}%`;

                // Update Pistol 3D
                if (gun) {
                    const gunX = (wrist.x - 0.5) * CONFIG.gunSensitivityX;
                    const gunY = -(wrist.y - 0.5) * CONFIG.gunSensitivityY;
                    
                    gun.object3D.position.x = gunX + 0.2; 
                    gun.object3D.position.y = gunY - 0.3; 
                    
                    const dx = indexTip.x - wrist.x;
                    const dy = indexTip.y - wrist.y;
                    const angleDeg = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                    
                    gun.object3D.rotation.z = THREE.Math.degToRad(angleDeg); 
                    gun.object3D.rotation.y = (handData.x - 0.5) * -1.0; 
                    gun.object3D.rotation.x = (handData.y - 0.5) * 0.8;  
                }

            } else {
                handData.detected = false;
                cursor.classList.remove('active');
                if(gun) {
                    gun.object3D.position.set(0.3, -0.5, -0.8);
                    gun.object3D.rotation.set(0, 0, 0);
                }
                status.style.display = 'block';
                status.innerText = "TANGAN HILANG!";
            }
        }

        // --- TITAN AI ---
        AFRAME.registerComponent('titan-ai', {
            init: function() { this.el.object3D.position.y = CONFIG.yOffset; },
            tick: function() {
                if (!gameState.running || this.el.dataset.dead === "true") return;
                const zPos = this.el.object3D.position;
                const camPos = document.querySelector('[gps-camera]').object3D.position;
                
                const dx = zPos.x - camPos.x;
                const dz = zPos.z - camPos.z;
                const dist = Math.sqrt(dx*dx + dz*dz);

                if (dist > 5) {
                    this.el.object3D.lookAt(camPos.x, zPos.y, camPos.z);
                    const dir = new THREE.Vector3(dx, 0, dz).normalize().negate(); 
                    this.el.object3D.position.addScaledVector(dir, 0.2); 
                }

                if (dist <= CONFIG.damageDistance) {
                    if (!this.lastHit || Date.now() - this.lastHit > 1000) {
                        takeDamage(15);
                        this.lastHit = Date.now();
                    }
                }
            }
        });

        // --- GAME LOGIC ---
        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            gameState.running = true;
            setupMediaPipe();
            processVideo();
            spawnWave();
            setInterval(updateRadar, 100);

            const fireBtn = document.getElementById('fire-btn');
            fireBtn.addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });
            fireBtn.addEventListener('mousedown', (e) => { e.preventDefault(); shoot(); });
            
            window.addEventListener('touchstart', (e) => { 
                if(e.target.id !== 'fire-btn') shoot(); 
            }, {passive: false});
        }

        function processVideo() {
            const video = document.querySelector('video');
            if (video && video.readyState >= 2) {
                hands.send({image: video}).then(() => {
                    if (gameState.running) requestAnimationFrame(processVideo);
                });
            } else {
                requestAnimationFrame(processVideo);
            }
        }

        function spawnWave() { for(let i=0; i<2; i++) spawnTitan(); }

        function spawnTitan() {
            const scene = document.querySelector('a-scene');
            const zombie = document.createElement('a-entity');
            zombie.setAttribute('titan-ai', '');
            zombie.classList.add('zombie');

            const cam = document.querySelector('[gps-camera]').object3D;
            const angle = Math.random() * Math.PI * 2;
            const dist = CONFIG.spawnDistMin + Math.random() * (CONFIG.spawnDistMax - CONFIG.spawnDistMin);
            
            zombie.setAttribute('position', {
                x: cam.position.x + Math.sin(angle) * dist,
                y: CONFIG.yOffset,
                z: cam.position.z + Math.cos(angle) * dist
            });

            const model = document.createElement('a-entity');
            model.setAttribute('gltf-model', '#titan-model');
            model.setAttribute('scale', `${CONFIG.modelScale} ${CONFIG.modelScale} ${CONFIG.modelScale}`);
            model.setAttribute('animation-mixer', 'clip: *; loop: repeat; timeScale: 1.5');
            zombie.appendChild(model);

            // HITBOX RAKSASA (Cube Invisible di sekitar model)
            const hitbox = document.createElement('a-box');
            hitbox.setAttribute('material', 'visible: false'); // Invisible
            hitbox.setAttribute('scale', '8 35 8'); // Besar & Tinggi
            hitbox.setAttribute('position', '0 15 0'); // Offset ke atas agar menutupi badan
            hitbox.classList.add('hitbox'); 
            zombie.appendChild(hitbox);

            scene.appendChild(zombie);
            gameState.zombies.push(zombie);
        }

        function shoot() {
            if (!gameState.running || gameState.ammo <= 0) return;
            gameState.ammo--; updateHUD();

            // Recoil
            const gun = document.getElementById('player-gun');
            if(gun) {
                gun.object3D.position.z += 0.2;
                document.getElementById('muzzle-flash').setAttribute('visible', 'true');
                setTimeout(() => {
                    gun.object3D.position.z -= 0.2;
                    document.getElementById('muzzle-flash').setAttribute('visible', 'false');
                }, 50);
            }

            // SHOOT LOGIC (FIXED)
            // Tembak dari Kamera -> Menuju Kursor Hijau
            const raycaster = new THREE.Raycaster();
            const camera = document.querySelector('[gps-camera]').object3D.children[0];
            
            // Konversi posisi kursor tangan ke NDC (-1..1)
            let aimX = 0, aimY = 0;
            if (handData.detected) {
                aimX = (handData.x * 2) - 1;
                aimY = -(handData.y * 2) + 1;
            }

            raycaster.setFromCamera(new THREE.Vector2(aimX, aimY), camera);
            
            // Raycast ke semua objek, tapi prioritaskan yang punya class 'hitbox'
            const intersects = raycaster.intersectObjects(document.querySelector('a-scene').object3D.children, true);

            for (let i = 0; i < intersects.length; i++) {
                let obj = intersects[i].object;
                let parent = obj.el;
                
                // Cari Zombie Parent
                while (parent && !parent.classList.contains('zombie')) {
                    parent = parent.parentNode;
                }

                if (parent && parent.dataset.dead !== "true") {
                    killZombie(parent);
                    break; 
                }
            }
        }

        function killZombie(el) {
            el.dataset.dead = "true";
            // Animasi Jatuh
            el.setAttribute('animation', 'property: rotation; to: -90 0 0; dur: 1200; easing: easeOutBounce');
            
            gameState.score++;
            updateHUD();
            setTimeout(() => {
                if (el.parentNode) el.parentNode.removeChild(el);
                gameState.zombies = gameState.zombies.filter(z => z !== el);
                if (gameState.zombies.length < 2) spawnTitan();
            }, 1500);
        }

        function takeDamage(amt) {
            gameState.hp -= amt;
            updateHUD();
            const flash = document.getElementById('damage-flash');
            flash.style.opacity = 1; setTimeout(() => flash.style.opacity = 0, 200);
            if (gameState.hp <= 0) {
                gameState.running = false;
                document.getElementById('game-over-screen').style.display = 'flex';
            }
        }

        function updateHUD() {
            document.getElementById('score').innerText = gameState.score;
            document.getElementById('ammo').innerText = gameState.ammo;
            document.getElementById('hp-bar').style.width = Math.max(0, gameState.hp) + '%';
        }

        function updateRadar() {
            const radar = document.getElementById('radar');
            radar.innerHTML = '<div class="radar-center"></div>';
            const cam = document.querySelector('[gps-camera]').object3D;
            const angle = cam.rotation.y;

            gameState.zombies.forEach(z => {
                if (z.dataset.dead === "true") return;
                const zPos = z.object3D.position;
                const dx = zPos.x - cam.position.x;
                const dz = zPos.z - cam.position.z;
                const rx = dx * Math.cos(angle) - dz * Math.sin(angle);
                const rz = dx * Math.sin(angle) + dz * Math.cos(angle);
                const px = 60 + (rx * CONFIG.radarScale);
                const py = 60 + (rz * CONFIG.radarScale); 
                if (Math.sqrt((px-60)**2 + (py-60)**2) < 60) {
                    const blip = document.createElement('div');
                    blip.className = 'radar-blip';
                    blip.style.left = px + 'px'; blip.style.top = py + 'px';
                    radar.appendChild(blip);
                }
            });
        }
    </script>
</body>
</html>
