<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Zombie Shooter: Apocalypse</title>
    
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    
    <!-- AR.js Library (Versi Standard untuk GPS/Location Based) -->
    <!-- Mengganti dari aframe-ar-nft.js ke aframe-ar.js untuk stabilitas GPS yang lebih baik -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    
    <!-- Extras & Look-at -->
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        /* UI Layer */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Blood Vignette Effect */
        #damage-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 100px rgba(255, 0, 0, 0);
            pointer-events: none;
            transition: box-shadow 0.2s;
            z-index: 5;
        }

        /* Crosshair */
        .crosshair-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .crosshair {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(0, 255, 255, 0.8);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .crosshair::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: #ff0000;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }

        .crosshair-line {
            position: absolute;
            background: rgba(0, 255, 255, 0.6);
        }

        .h-line { width: 60px; height: 1px; top: 50%; left: -10px; }
        .v-line { width: 1px; height: 60px; left: 50%; top: -10px; }

        /* Stats Panels */
        .hud-panel {
            position: absolute;
            padding: 15px;
            background: rgba(10, 20, 30, 0.85);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-left: 5px solid #00ffff;
            color: #fff;
            backdrop-filter: blur(5px);
            transform: skewX(-10deg);
        }

        .hud-value {
            font-family: 'Share Tech Mono', monospace;
            font-size: 24px;
            color: #00ffff;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.8);
        }

        .hud-label {
            font-size: 10px;
            color: #aaa;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        #score-panel { top: 20px; left: 20px; }
        #wave-panel { top: 20px; right: 20px; text-align: right; border-left: none; border-right: 5px solid #ffaa00; }
        #wave-panel .hud-value { color: #ffaa00; text-shadow: 0 0 5px rgba(255, 170, 0, 0.8); }

        #ammo-panel { 
            bottom: 30px; 
            right: 20px; 
            border-left: none; 
            border-right: 5px solid #ff0000;
            text-align: right;
        }
        #ammo-panel .hud-value { color: #ff0000; font-size: 32px; }

        /* Radar / GPS Debug */
        #radar-panel {
            bottom: 30px;
            left: 20px;
            width: 150px;
            font-size: 10px;
            color: #0f0;
            font-family: 'Share Tech Mono', monospace;
            opacity: 0.7;
        }

        /* Screens (Start, Game Over) */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            pointer-events: auto;
            text-align: center;
        }

        h1 {
            font-size: 40px;
            color: #ff0000;
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        p { color: #ccc; margin-bottom: 30px; max-width: 80%; line-height: 1.6; }

        .btn {
            background: linear-gradient(45deg, #cc0000, #990000);
            color: white;
            padding: 15px 40px;
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            border: none;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            cursor: pointer;
            transition: transform 0.2s, filter 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn:active { transform: scale(0.95); }
        .btn:hover { filter: brightness(1.2); }

        /* Loading */
        #loading-screen { z-index: 90; display: none; }
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #00ffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Effects */
        .hit-indicator {
            position: absolute;
            color: #ff0000;
            font-weight: 900;
            font-size: 24px;
            animation: floatUp 0.8s ease-out forwards;
            pointer-events: none;
            text-shadow: 0 0 5px black;
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1.5); opacity: 0; }
        }
    </style>
</head>

<body>
    <!-- Damage Vignette -->
    <div id="damage-overlay"></div>

    <!-- UI Overlay -->
    <div id="ui-layer">
        <div class="crosshair-container">
            <div class="crosshair-line h-line"></div>
            <div class="crosshair-line v-line"></div>
            <div class="crosshair"></div>
        </div>

        <div id="score-panel" class="hud-panel">
            <div class="hud-label">Kills Confirmed</div>
            <div class="hud-value" id="score">0</div>
        </div>

        <div id="wave-panel" class="hud-panel">
            <div class="hud-label">Threat Level</div>
            <div class="hud-value">WAVE <span id="wave">1</span></div>
        </div>

        <div id="ammo-panel" class="hud-panel">
            <div class="hud-label">Ammunition</div>
            <div class="hud-value"><span id="ammo">30</span> / âˆž</div>
        </div>

        <div id="radar-panel">
            <div>GPS SIGNAL: <span id="gps-status" style="color:red">SEARCHING</span></div>
            <div>TARGETS: <span id="zombie-count">0</span></div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="fullscreen-overlay">
        <h1>Zombie Protocol</h1>
        <p>Monster terdeteksi di lokasi Anda.<br>Gunakan kamera untuk menemukan mereka.<br>Tap layar untuk menembak.</p>
        <button class="btn" id="start-btn">INITIATE MISSION</button>
        <p style="font-size: 12px; margin-top: 20px; color: #666;">Pastikan Akses Kamera & Lokasi Diizinkan.<br>Gunakan HTTPS jika di-hosting.</p>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fullscreen-overlay">
        <div class="loader"></div>
        <p style="margin-top: 20px;">Calibrating GPS Sensors...</p>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="fullscreen-overlay" style="display: none;">
        <h1>M.I.A.</h1>
        <p>Misi Gagal. Amunisi Habis.<br>Total Kills: <span id="final-score" style="color: #00ffff; font-weight: bold;">0</span></p>
        <button class="btn" id="restart-btn">RETRY MISSION</button>
    </div>

    <!-- AR Scene 
         PERBAIKAN KAMERA:
         1. Menghapus 'embedded' agar full screen native
         2. Menghapus resolusi statis (sourceWidth/Height) agar auto-detect
         3. Menggunakan parameter standard untuk webcam
    -->
    <a-scene
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        arjs='sourceType: webcam; debugUIEnabled: false; videoTexture: true;'>
        
        <a-assets>
            <a-asset-item id="monster-model" src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Monster/glTF-Binary/Monster.glb"></a-asset-item>
        </a-assets>

        <!-- Lighting -->
        <a-light type="ambient" color="#ffffff" intensity="0.5"></a-light>
        <a-light type="directional" color="#ffffff" intensity="1" position="-1 1 0"></a-light>

        <!-- Camera GPS 
             Menambahkan simulateLatitude/Longitude untuk testing jika di desktop (opsional, saat ini dimatikan)
        -->
        <a-camera gps-camera rotation-reader>
        </a-camera>

    </a-scene>

    <script>
        // --- Game Configuration ---
        const CONFIG = {
            maxZombies: 5,
            spawnRadiusMin: 10,
            spawnRadiusMax: 25, // meters
            startAmmo: 25,
            modelScale: 0.05 
        };

        // --- State Management ---
        let state = {
            score: 0,
            ammo: CONFIG.startAmmo,
            wave: 1,
            zombies: [], // Array of zombie elements
            isGameRunning: false,
            userLocation: null
        };

        // --- DOM Elements ---
        const ui = {
            score: document.getElementById('score'),
            ammo: document.getElementById('ammo'),
            wave: document.getElementById('wave'),
            gps: document.getElementById('gps-status'),
            zombieCount: document.getElementById('zombie-count'),
            startScreen: document.getElementById('start-screen'),
            loadingScreen: document.getElementById('loading-screen'),
            gameOverScreen: document.getElementById('game-over-screen'),
            scene: document.querySelector('a-scene'),
            damageOverlay: document.getElementById('damage-overlay')
        };

        // --- Game Logic ---

        // 1. Raycaster Implementation (Shooting)
        const raycaster = new THREE.Raycaster();
        const centerScreen = new THREE.Vector2(0, 0); // Normalized device coordinates for center

        function shoot() {
            if (!state.isGameRunning || state.ammo <= 0) return;

            // Recoil Animation Effect
            const crosshair = document.querySelector('.crosshair');
            crosshair.style.transform = "scale(1.5)";
            setTimeout(() => crosshair.style.transform = "scale(1)", 100);

            // Decrease Ammo
            state.ammo--;
            updateHUD();

            // Muzzle Flash Effect (Simple white flash)
            ui.damageOverlay.style.boxShadow = "inset 0 0 50px rgba(255, 255, 200, 0.5)";
            setTimeout(() => ui.damageOverlay.style.boxShadow = "none", 50);

            // Raycast logic
            const camera = document.querySelector('[gps-camera]').object3D.children[0]; 
            if(!camera) return;

            raycaster.setFromCamera(centerScreen, camera);
            
            const zombieMeshes = [];
            state.zombies.forEach(z => {
                if(z.object3D) zombieMeshes.push(z.object3D);
            });

            const intersects = raycaster.intersectObjects(zombieMeshes, true);

            if (intersects.length > 0) {
                const hitObject = intersects[0].object;
                
                let entity = hitObject.el;
                while(entity && !entity.classList.contains('zombie')) {
                    entity = entity.parentNode;
                }

                if (entity && entity.classList.contains('zombie')) {
                    hitZombie(entity);
                }
            }

            if (state.ammo === 0 && state.zombies.length > 0) {
                setTimeout(checkGameOver, 1000);
            }
        }

        function hitZombie(entity) {
            if (entity.dataset.dead === "true") return;

            entity.dataset.dead = "true";
            
            showHitMarker();
            
            entity.setAttribute('animation', {
                property: 'scale',
                to: '0 0 0',
                dur: 500,
                easing: 'easeInBack'
            });

            setTimeout(() => {
                if (entity.parentNode) entity.parentNode.removeChild(entity);
                state.zombies = state.zombies.filter(z => z !== entity);
                state.score++;
                updateHUD();
                
                if (state.zombies.length === 0) {
                    startNextWave();
                }
            }, 500);
        }

        function showHitMarker() {
            const marker = document.createElement('div');
            marker.className = 'hit-indicator';
            marker.innerText = "HIT!";
            marker.style.top = '50%';
            marker.style.left = '50%';
            document.body.appendChild(marker);
            setTimeout(() => marker.remove(), 800);
        }

        // 2. Spawning System
        function spawnZombie() {
            if (!state.userLocation) return;

            const zombie = document.createElement('a-entity');
            zombie.classList.add('zombie');
            
            const angle = Math.random() * Math.PI * 2;
            const distance = CONFIG.spawnRadiusMin + Math.random() * (CONFIG.spawnRadiusMax - CONFIG.spawnRadiusMin);
            
            const latOffset = (Math.cos(angle) * distance) / 111111;
            const lngOffset = (Math.sin(angle) * distance) / (111111 * Math.cos(state.userLocation.latitude * Math.PI / 180));
            
            const lat = state.userLocation.latitude + latOffset;
            const lng = state.userLocation.longitude + lngOffset;

            zombie.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng}`);
            zombie.setAttribute('look-at', '[gps-camera]');

            const modelWrapper = document.createElement('a-entity');
            modelWrapper.setAttribute('position', '0 -1.6 0'); 
            modelWrapper.setAttribute('gltf-model', '#monster-model');
            modelWrapper.setAttribute('scale', `${CONFIG.modelScale} ${CONFIG.modelScale} ${CONFIG.modelScale}`);
            modelWrapper.setAttribute('animation-mixer', 'clip: *; loop: repeat; timeScale: 1');

            zombie.appendChild(modelWrapper);
            ui.scene.appendChild(zombie);
            state.zombies.push(zombie);
            updateHUD();
        }

        function startNextWave() {
            state.wave++;
            state.ammo += 10; 
            
            const announcement = document.createElement('div');
            announcement.style.cssText = "position:fixed; top:30%; width:100%; text-align:center; color:#ffaa00; font-size:40px; font-weight:bold; text-shadow:0 0 20px black; z-index:20; pointer-events:none;";
            announcement.innerText = `WAVE ${state.wave}`;
            document.body.appendChild(announcement);
            setTimeout(() => announcement.remove(), 3000);

            const count = Math.min(state.wave + 2, CONFIG.maxZombies);
            for(let i=0; i<count; i++) {
                setTimeout(spawnZombie, i * 1000); 
            }
            updateHUD();
        }

        function checkGameOver() {
            if (state.ammo <= 0 && state.zombies.length > 0) {
                state.isGameRunning = false;
                document.getElementById('final-score').innerText = state.score;
                ui.gameOverScreen.style.display = 'flex';
                // Note: We don't hide ui-layer completely, just maybe the HUD parts?
                // Keeping it simpler for now
            }
        }

        function updateHUD() {
            ui.score.innerText = state.score;
            ui.ammo.innerText = state.ammo;
            ui.wave.innerText = state.wave;
            ui.zombieCount.innerText = state.zombies.length;
            
            if (state.ammo <= 5) ui.ammo.style.color = 'red';
            else ui.ammo.style.color = '#ff0000';
        }

        // --- Initialization ---

        function initGame(position) {
            state.userLocation = position.coords;
            ui.gps.innerText = "LOCKED";
            ui.gps.style.color = "#00ff00";
            
            state.isGameRunning = true;
            ui.loadingScreen.style.display = 'none';
            
            window.addEventListener('click', shoot);
            window.addEventListener('touchstart', (e) => {
                shoot();
            }, {passive: false});

            startNextWave();
        }

        document.getElementById('start-btn').addEventListener('click', () => {
            ui.startScreen.style.display = 'none';
            ui.loadingScreen.style.display = 'flex';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    initGame,
                    (err) => {
                        alert("GPS Error: " + err.message);
                        ui.loadingScreen.style.display = 'none';
                        ui.startScreen.style.display = 'flex';
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 }
                );
            } else {
                alert("Browser tidak mendukung Geolocation.");
            }
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            location.reload();
        });

    </script>
</body>
</html>
