<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Zombie Shooter: Final Project</title>
    
    <!-- Libraries A-Frame & AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* RESET */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
        }

        /* FULLSCREEN VIDEO FIX */
        #arjs-video, video {
            width: 100% !important; height: 100% !important;
            top: 0 !important; left: 0 !important;
            z-index: -2 !important; object-fit: cover !important;
            margin: 0 !important; position: absolute !important;
        }

        /* UI LAYER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 999;
            display: flex; flex-direction: column; justify-content: space-between;
            transition: transform 0.1s;
        }

        /* DAMAGE ANIMATION */
        .shake-anim {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
            40%, 60% { transform: translate3d(8px, 0, 0); }
        }

        #damage-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255, 0, 0, 0.2) 20%, rgba(255, 0, 0, 0.9) 100%);
            opacity: 0; pointer-events: none; z-index: 900;
            transition: opacity 0.1s ease-out;
            mix-blend-mode: multiply;
        }
        .critical-health { animation: pulseRed 1s infinite alternate; }
        @keyframes pulseRed { from { opacity: 0.3; } to { opacity: 0.7; } }

        /* HUD STYLING */
        .hud-panel {
            background: rgba(10, 20, 30, 0.85); border: 1px solid rgba(0, 255, 255, 0.5);
            padding: 10px; transform: skewX(-15deg);
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        .hud-label { font-size: 10px; color: #00ffff; font-family: 'Share Tech Mono', monospace; transform: skewX(15deg); letter-spacing: 1px; }
        .hud-value { font-size: 24px; color: #fff; font-family: 'Orbitron', sans-serif; font-weight: 900; transform: skewX(15deg); text-shadow: 0 0 5px #0ff; }

        .hud-top { display: flex; justify-content: space-between; padding: 20px; padding-top: max(20px, env(safe-area-inset-top)); }
        .hud-bottom { display: flex; align-items: flex-end; justify-content: space-between; padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom)); }

        .health-container { width: 180px; transform: skewX(-15deg); }
        .health-bar-bg { width: 100%; height: 15px; background: #300; border: 2px solid #f00; box-shadow: 0 0 5px #f00; }
        .health-bar-fill { width: 100%; height: 100%; background: #f00; transition: width 0.2s; box-shadow: inset 0 0 10px #500; }

        .crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px; border: 2px solid #0ff; border-radius: 50%;
            transform: translate(-50%, -50%); opacity: 0.8; box-shadow: 0 0 5px #0ff;
        }
        .crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: red;
            transform: translate(-50%, -50%); border-radius: 50%;
        }

        .radar-box {
            position: absolute; bottom: 90px; left: 20px;
            width: 90px; height: 90px; border: 2px solid #0f0; border-radius: 50%;
            background: rgba(0, 20, 0, 0.7); overflow: hidden; box-shadow: 0 0 10px #0f0;
        }
        .radar-center { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #fff; transform: translate(-50%, -50%); border-radius: 50%; }
        .radar-blip { position: absolute; width: 8px; height: 8px; background: red; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 4px #fff; }

        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; pointer-events: auto;
        }
        .btn {
            background: #c00; color: #fff; padding: 15px 40px;
            font-family: 'Orbitron'; font-weight: bold; border: 2px solid #f00;
            margin-top: 20px; text-transform: uppercase; letter-spacing: 2px;
            box-shadow: 0 0 15px #f00; cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="damage-flash"></div>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="hud-panel" style="border-left: 5px solid #0ff;">
                <div class="hud-label">KILLS</div>
                <div class="hud-value" id="score">0</div>
            </div>
            <div class="hud-panel" style="border-right: 5px solid #fa0;">
                <div class="hud-label">WAVE</div>
                <div class="hud-value" id="wave">1</div>
            </div>
        </div>

        <div class="crosshair"></div>
        
        <div class="radar-box" id="radar">
            <div class="radar-center"></div>
        </div>

        <div class="hud-bottom">
            <div class="health-container">
                <div class="hud-label" style="color:#fff; margin-bottom:5px;">HP INTEGRITY</div>
                <div class="health-bar-bg">
                    <div class="health-bar-fill" id="hp-bar"></div>
                </div>
            </div>
            <div class="hud-panel" style="border-right: 5px solid #f00;">
                <div class="hud-label" style="color:#f55;">AMMO</div>
                <div class="hud-value" style="color:#f00;" id="ammo">25</div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="fullscreen-overlay">
        <h1 style="font-family:'Orbitron'; color:red; text-shadow:0 0 10px red;">ZOMBIE PROTOCOL</h1>
        <p style="color:#aaa; font-family:'Share Tech Mono'; font-size: 14px; line-height: 1.5;">
            MUSUH UKURAN RAKSASA TERDETEKSI.<br>
            BERTAHAN HIDUP SEKUAT TENAGA.
        </p>
        <button class="btn" onclick="startGame()">DEPLOY MISSION</button>
        <button class="btn" style="margin-top:10px; background:#222; border-color:#555; font-size:10px; padding:10px;" onclick="forceStart()">⚠️ INDOOR TEST MODE</button>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="fullscreen-overlay" style="display: none;">
        <h1 style="font-family:'Orbitron'; color:red; font-size: 40px;">FATAL ERROR</h1>
        <p style="color:#fff; font-family:'Share Tech Mono';">OPERATOR KILLED IN ACTION<br>Total Kills: <span id="final-score" style="color:#0ff; font-weight:bold;">0</span></p>
        <button class="btn" onclick="location.reload()">REBOOT SYSTEM</button>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'
        loading-screen="enabled: false">

        <a-assets timeout="10000">
            <a-asset-item id="zombie-model" src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/BrainStem/glTF-Binary/BrainStem.glb"></a-asset-item>
        </a-assets>

        <a-light type="ambient" color="#fff" intensity="1.0"></a-light>
        <a-light type="directional" color="#fff" intensity="1.5" position="-1 1 0"></a-light>

        <a-camera gps-camera rotation-reader far="1000"></a-camera>
    </a-scene>

    <script>
        // CONFIG
        const CONFIG = {
            speed: 0.05,        
            hitDistance: 3.5,   
            spawnDistMin: 5,    
            spawnDistMax: 10,    
            maxHp: 100,
            damage: 10          
        };

        // STATE
        let gameState = {
            running: false, score: 0, ammo: 25, wave: 1, hp: 100, zombies: []
        };

        // ZOMBIE AI COMPONENT
        AFRAME.registerComponent('zombie-ai', {
            init: function() {
                // FIX: Menurunkan posisi Y ke -10 agar terlihat menapak di tanah (sangat jauh di bawah kamera)
                this.el.object3D.position.y = -10; 
            },
            tick: function() {
                if (!gameState.running || this.el.dataset.dead === "true") return;

                const zombiePos = this.el.object3D.position;
                const camera = document.querySelector('[gps-camera]').object3D;
                const camPos = camera.position;

                // Hitung jarak Horizontal
                const dx = zombiePos.x - camPos.x;
                const dz = zombiePos.z - camPos.z;
                const distHorizontal = Math.sqrt(dx*dx + dz*dz);

                // Logika Chase
                if (distHorizontal > 1.5) { 
                    this.el.object3D.lookAt(camPos.x, zombiePos.y, camPos.z);
                    
                    const dir = new THREE.Vector3();
                    const zWorld = new THREE.Vector3();
                    const cWorld = new THREE.Vector3();
                    this.el.object3D.getWorldPosition(zWorld);
                    camera.getWorldPosition(cWorld);

                    dir.subVectors(cWorld, zWorld).normalize();
                    dir.y = 0; 
                    
                    this.el.object3D.position.addScaledVector(dir, CONFIG.speed);
                }

                // Logika Hit
                if (distHorizontal <= CONFIG.hitDistance) {
                    if (!this.lastHit || Date.now() - this.lastHit > 1000) { 
                        takeDamage(CONFIG.damage);
                        this.lastHit = Date.now();
                    }
                }
            }
        });

        // GAME LOGIC
        function startGame() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    initGame(pos.coords);
                }, (err) => {
                    alert("GPS Error. Mode Indoor Aktif.");
                    forceStart();
                });
            } else { forceStart(); }
        }

        function forceStart() { initGame({ latitude: 0, longitude: 0 }); }

        function initGame(coords) {
            document.getElementById('start-screen').style.display = 'none';
            gameState.running = true;
            gameState.userLoc = coords;
            
            window.addEventListener('click', shoot);
            window.addEventListener('touchstart', shoot, {passive: false});

            spawnWave();
            setInterval(updateRadar, 200);
        }

        function spawnWave() {
            let count = Math.min(gameState.wave + 2, 8);
            for(let i=0; i<count; i++) setTimeout(spawnZombie, i * 1500);
        }

        function spawnZombie() {
            const scene = document.querySelector('a-scene');
            const zombie = document.createElement('a-entity');
            
            zombie.setAttribute('zombie-ai', '');
            zombie.classList.add('zombie');

            const angle = Math.random() * Math.PI * 2;
            const dist = CONFIG.spawnDistMin + Math.random() * (CONFIG.spawnDistMax - CONFIG.spawnDistMin);
            const x = Math.sin(angle) * dist;
            const z = Math.cos(angle) * dist;

            // Posisi awal di Y=-10
            zombie.setAttribute('position', `${x} -10 ${z}`);

            const model = document.createElement('a-entity');
            model.setAttribute('gltf-model', '#zombie-model');
            // SCALE DIPERBESAR JADI 8x
            model.setAttribute('scale', '8 8 8');
            model.setAttribute('animation-mixer', 'clip: *; loop: repeat; timeScale: 1');
            zombie.appendChild(model);

            const box = document.createElement('a-box');
            box.setAttribute('color', 'red');
            box.setAttribute('width', '1'); box.setAttribute('height', '4'); box.setAttribute('depth', '1');
            box.setAttribute('visible', 'false');
            zombie.appendChild(box);

            model.addEventListener('model-error', () => {
                model.setAttribute('visible', 'false');
                box.setAttribute('visible', 'true');
            });

            scene.appendChild(zombie);
            gameState.zombies.push(zombie);
        }

        function shoot() {
            if (!gameState.running || gameState.ammo <= 0) return;
            gameState.ammo--; updateUI();

            const crosshair = document.querySelector('.crosshair');
            crosshair.style.transform = 'translate(-50%, -50%) scale(1.2)';
            setTimeout(() => crosshair.style.transform = 'translate(-50%, -50%) scale(1)', 100);

            const raycaster = new THREE.Raycaster();
            const center = new THREE.Vector2(0, 0);
            const camera = document.querySelector('[gps-camera]').object3D.children[0];
            raycaster.setFromCamera(center, camera);
            
            const intersects = raycaster.intersectObjects(document.querySelector('a-scene').object3D.children, true);
            
            for (let i = 0; i < intersects.length; i++) {
                let obj = intersects[i].object;
                let parent = obj.el;
                while (parent && !parent.classList.contains('zombie')) parent = parent.parentNode;
                
                if (parent && parent.classList.contains('zombie') && parent.dataset.dead !== "true") {
                    killZombie(parent);
                    break;
                }
            }
        }

        function killZombie(el) {
            el.dataset.dead = "true";
            el.setAttribute('animation', 'property: scale; to: 0 0 0; dur: 500; easing: easeInBack');
            showHitMarker();
            setTimeout(() => {
                if (el.parentNode) el.parentNode.removeChild(el);
                gameState.zombies = gameState.zombies.filter(z => z !== el);
                gameState.score++; updateUI();
                if (gameState.zombies.length === 0) {
                    gameState.wave++; gameState.ammo += 10;
                    showWaveNotif(); updateUI(); spawnWave();
                }
            }, 500);
        }

        function showHitMarker() {
            const marker = document.createElement('div');
            marker.style.cssText = "position:absolute; top:50%; left:50%; width:30px; height:30px; border:3px solid red; transform:translate(-50%,-50%) rotate(45deg); pointer-events:none; z-index:9999;";
            document.body.appendChild(marker);
            setTimeout(() => marker.remove(), 100);
        }

        function showWaveNotif() {
            const waveNotif = document.createElement('div');
            waveNotif.innerText = `WAVE ${gameState.wave}`;
            waveNotif.style.cssText = "position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); color:orange; font-size:40px; font-weight:bold; font-family:'Orbitron'; text-shadow:0 0 10px orange; pointer-events:none;";
            document.body.appendChild(waveNotif);
            setTimeout(() => waveNotif.remove(), 2000);
        }

        function takeDamage(amount) {
            gameState.hp -= amount; updateUI();
            const flash = document.getElementById('damage-flash');
            flash.style.opacity = 1; setTimeout(() => flash.style.opacity = 0, 250);
            
            const uiLayer = document.getElementById('ui-layer');
            uiLayer.classList.add('shake-anim'); setTimeout(() => uiLayer.classList.remove('shake-anim'), 500);

            if (gameState.hp <= 30 && gameState.hp > 0) flash.classList.add('critical-health');
            else flash.classList.remove('critical-health');

            if (gameState.hp <= 0) gameOver();
        }

        function gameOver() {
            gameState.running = false;
            document.getElementById('final-score').innerText = gameState.score;
            document.getElementById('game-over-screen').style.display = 'flex';
            document.getElementById('damage-flash').classList.remove('critical-health');
            document.getElementById('damage-flash').style.opacity = 0;
        }

        function updateUI() {
            document.getElementById('score').innerText = gameState.score;
            document.getElementById('wave').innerText = gameState.wave;
            document.getElementById('ammo').innerText = gameState.ammo;
            document.querySelector('.health-bar-fill').style.width = Math.max(0, gameState.hp) + '%';
        }

        function updateRadar() {
            const radar = document.getElementById('radar');
            document.querySelectorAll('.radar-blip').forEach(b => b.remove());
            const camera = document.querySelector('[gps-camera]').object3D;
            const camAngle = camera.rotation.y; 
            gameState.zombies.forEach(z => {
                if(z.dataset.dead === "true") return;
                const zPos = z.object3D.position;
                const dx = zPos.x - camera.position.x;
                const dz = zPos.z - camera.position.z;
                const rX = dx * Math.cos(camAngle) - dz * Math.sin(camAngle);
                const rZ = dx * Math.sin(camAngle) + dz * Math.cos(camAngle);
                const scale = 3; 
                const uiX = 45 + (rX * scale);
                const uiY = 45 + (rZ * scale); 
                if (Math.sqrt((uiX-45)**2 + (uiY-45)**2) < 45) {
                    const blip = document.createElement('div');
                    blip.className = 'radar-blip';
                    blip.style.left = uiX + 'px'; blip.style.top = uiY + 'px';
                    radar.appendChild(blip);
                }
            });
        }
    </script>
</body>
</html>
