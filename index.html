<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Zombie Shooter: Marker Edition</title>
    
    <!-- A-Frame & AR.js (Versi Stabil untuk Marker) -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* RESET */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; user-select: none; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 999;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        #damage-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 30%, rgba(255, 0, 0, 0.8) 100%);
            opacity: 0; transition: opacity 0.1s; pointer-events: none; z-index: 2000;
            mix-blend-mode: overlay;
        }

        /* HUD */
        .hud-top { display: flex; justify-content: space-between; padding: 20px; padding-top: max(20px, env(safe-area-inset-top)); }
        
        .hud-panel {
            background: rgba(0, 15, 30, 0.85); border: 1px solid rgba(0, 255, 255, 0.6);
            padding: 10px 25px; transform: skewX(-15deg); text-align: center;
        }
        .hud-label { font-family: 'Share Tech Mono'; font-size: 10px; color: #00ffff; }
        .hud-value { font-family: 'Orbitron'; font-size: 28px; color: #fff; font-weight: 900; }
        
        .hud-bottom { display: flex; align-items: flex-end; justify-content: space-between; padding: 20px; padding-bottom: max(30px, env(safe-area-inset-bottom)); }

        .crosshair {
            position: absolute; width: 60px; height: 60px; 
            border: 2px solid #0f0; border-radius: 50%;
            transform: translate(-50%, -50%); opacity: 0.8; 
            box-shadow: 0 0 15px #0f0, inset 0 0 10px #0f0; pointer-events: none;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            left: 50%; top: 50%;
        }
        .crosshair.locked { border-color: red; background: rgba(255, 0, 0, 0.2); transform: translate(-50%, -50%) scale(1.2); }
        .crosshair::after { content: ''; width: 4px; height: 4px; background: #fff; border-radius: 50%; }

        #fire-btn {
            position: absolute; bottom: 120px; right: 30px; width: 100px; height: 100px;
            border-radius: 50%; background: rgba(255, 0, 0, 0.3); border: 4px solid #ff0000;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron'; color: white; font-weight: bold; pointer-events: auto;
        }
        #fire-btn:active { transform: scale(0.9); background: rgba(255, 0, 0, 0.8); }

        #marker-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 200px; height: 200px; border: 2px dashed rgba(255, 255, 255, 0.5);
            pointer-events: none; display: flex; align-items: center; justify-content: center;
            color: white; font-family: 'Share Tech Mono'; text-align: center;
        }

        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .btn-start {
            background: linear-gradient(45deg, #cc0000, #990000); color: #fff; padding: 15px 50px;
            font-family: 'Orbitron'; font-size: 20px; border: none; cursor: pointer; margin-top: 20px;
        }
    </style>
</head>

<body>
    <div id="damage-flash"></div>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="hud-panel"><div class="hud-label">KILLS</div><div class="hud-value" id="score">0</div></div>
            <div class="hud-panel"><div class="hud-label">WAVE</div><div class="hud-value" id="wave">1</div></div>
        </div>

        <div class="crosshair" id="finger-cursor"></div>
        
        <!-- Guide untuk mengarahkan ke Marker -->
        <div id="marker-guide">ARAHKAN KAMERA<br>KE MARKER HIRO</div>

        <div id="fire-btn">FIRE</div>

        <div class="hud-bottom">
            <div style="transform: skewX(-15deg);">
                <div class="hud-label">HP INTEGRITY</div>
                <div style="width: 150px; height: 10px; border: 1px solid red;">
                    <div id="hp-bar" style="width: 100%; height: 100%; background: red;"></div>
                </div>
            </div>
            <div class="hud-panel"><div class="hud-label">AMMO</div><div class="hud-value" id="ammo">100</div></div>
        </div>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen" class="fullscreen-overlay">
        <h1 style="font-family:'Orbitron'; color:red;">ZOMBIE PROTOCOL</h1>
        <p style="color:#aaa; font-family:'Share Tech Mono'; font-size: 14px; max-width: 300px;">
            MODE: MARKER BASE (STABIL)<br><br>
            Siapkan gambar "HIRO MARKER".<br>
            Zombie akan keluar dari marker tersebut.
        </p>
        <button class="btn-start" onclick="startGame()">START MISSION</button>
    </div>

    <div id="game-over-screen" class="fullscreen-overlay" style="display: none;">
        <h1 style="color:red; font-family:'Orbitron';">KILLED IN ACTION</h1>
        <button class="btn-start" onclick="location.reload()">RETRY</button>
    </div>

    <!-- AR.JS SCENE (MARKER BASED) -->
    <a-scene 
        embedded 
        arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false">

        <a-assets>
            <a-asset-item id="titan-model" src="https://raw.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/CesiumMan/glTF-Binary/CesiumMan.glb"></a-asset-item>
        </a-assets>

        <!-- CAMERA -->
        <a-entity camera look-controls="enabled: false"></a-entity>

        <!-- MARKER HIRO (TITIK SPAWN MANUAL) -->
        <a-marker preset="hiro" id="marker-root">
            <!-- Portal Visual -->
            <a-ring color="red" radius-inner="0.5" radius-outer="0.6" rotation="-90 0 0">
                <a-animation attribute="scale" from="1 1 1" to="1.2 1.2 1.2" dur="1000" repeat="indefinite" direction="alternate"></a-animation>
            </a-ring>
            <!-- Zombie Container (Zombies will be added here) -->
            <a-entity id="zombie-container"></a-entity>
        </a-marker>

    </a-scene>

    <script>
        const CONFIG = {
            modelScale: 2.0, // Skala relatif terhadap marker (Marker biasanya kecil di layar)
            damageDistance: 0.8, // Jarak dalam satuan marker
            lerpFactor: 0.3
        };

        let gameState = { running: false, score: 0, hp: 100, ammo: 100, zombies: [] };
        let handData = { x: 0.5, y: 0.5, detected: false };

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            gameState.running = true;
            
            // Coba init hand tracking (bisa gagal kalau HP kentang/konflik, tapi game ga akan crash)
            setupMediaPipe();
            
            spawnWave();
            gameLoop();

            const fireBtn = document.getElementById('fire-btn');
            fireBtn.addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });
            fireBtn.addEventListener('mousedown', (e) => { e.preventDefault(); shoot(); });
            
            // Listener untuk Marker Found/Lost
            const marker = document.querySelector('a-marker');
            marker.addEventListener('markerFound', () => {
                document.getElementById('marker-guide').style.display = 'none';
            });
            marker.addEventListener('markerLost', () => {
                document.getElementById('marker-guide').style.display = 'flex';
                document.getElementById('marker-guide').innerHTML = "MARKER HILANG!<br>Cari Marker Hiro";
            });
        }

        // --- HAND TRACKING (Fallback Safe) ---
        let hands;
        function setupMediaPipe() {
            try {
                hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5});
                hands.onResults(onHandResults);
                
                // Hook ke video element yang dibuat AR.js
                const checkVideo = setInterval(() => {
                    const v = document.querySelector('video'); // AR.js video
                    if(v) {
                        clearInterval(checkVideo);
                        async function tick() {
                            if(gameState.running) {
                                try { await hands.send({image: v}); } catch(e){}
                                requestAnimationFrame(tick);
                            }
                        }
                        tick();
                    }
                }, 1000);
            } catch(e) { console.log("Hand tracking failed to init"); }
        }

        function onHandResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                handData.detected = true;
                const p = results.multiHandLandmarks[0][8]; // Telunjuk
                handData.x = 1.0 - p.x; 
                handData.y = p.y;
            } else {
                handData.detected = false;
            }
        }

        function gameLoop() {
            if(!gameState.running) return;

            // Update UI Cursor
            const cursor = document.getElementById('finger-cursor');
            let aimX = 0.5, aimY = 0.5;

            if (handData.detected) {
                aimX = handData.x;
                aimY = handData.y;
                cursor.classList.add('active');
            } else {
                cursor.classList.remove('active'); // Balik ke tengah (Head Aim)
            }
            
            cursor.style.left = (aimX * 100) + '%';
            cursor.style.top = (aimY * 100) + '%';

            // Zombie Logic (Marker Relative)
            // Kamera selalu di 0,0,0 World Space di AR.js
            // Marker bergerak di World Space.
            // Zombie adalah anak Marker.
            const camPos = new THREE.Vector3(0,0,0); // Camera is origin
            
            gameState.zombies.forEach(z => {
                if(z.el.dataset.dead === "true") return;

                // Dapatkan posisi Zombie dalam World Space (bukan local marker)
                const zWorldPos = new THREE.Vector3();
                z.el.object3D.getWorldPosition(zWorldPos);

                const dist = zWorldPos.distanceTo(camPos); // Jarak sebenarnya ke kamera

                // Chase: Gerakkan zombie di Local Space (di dalam marker)
                // Ini agak tricky matematikanya, tapi simpelnya:
                // Kita mau zombie bergerak mendekati kamera (0,0,0 dunia).
                // Kita konversi (0,0,0 dunia) ke Local Space Marker.
                const markerEl = document.querySelector('a-marker');
                if(markerEl.object3D.visible) {
                    const targetLocal = markerEl.object3D.worldToLocal(new THREE.Vector3(0,0,0));
                    z.el.object3D.lookAt(targetLocal);
                    
                    // Gerak maju
                    if(dist > 0.5) {
                        z.el.object3D.translateZ(0.03); // Maju relatif zombie
                    }

                    // Attack
                    if(dist < CONFIG.damageDistance) {
                        if(Date.now() - z.lastAttack > 1000) {
                            damagePlayer();
                            z.lastAttack = Date.now();
                        }
                    }
                }
            });

            requestAnimationFrame(gameLoop);
        }

        function spawnWave() {
            setInterval(() => {
                if(gameState.zombies.length < 5) spawnZombie();
            }, 3000);
        }

        function spawnZombie() {
            const container = document.getElementById('zombie-container');
            const el = document.createElement('a-entity');
            
            // Spawn di sekitar marker (radius kecil)
            const angle = Math.random() * Math.PI * 2;
            const r = 0.5; // Dekat marker
            el.setAttribute('position', `${Math.sin(angle)*r} 0 ${Math.cos(angle)*r}`);
            el.setAttribute('scale', `${CONFIG.modelScale} ${CONFIG.modelScale} ${CONFIG.modelScale}`);
            el.setAttribute('gltf-model', '#titan-model');
            el.setAttribute('animation-mixer', 'timeScale: 2.0'); // Lari cepat
            
            container.appendChild(el);
            gameState.zombies.push({el: el, lastAttack: 0});
        }

        function shoot() {
            if(gameState.ammo <= 0) return;
            gameState.ammo--;
            document.getElementById('ammo').innerText = gameState.ammo;

            // Logic Hit (Simple Screen Center / Cursor Check)
            const cursor = document.getElementById('finger-cursor');
            const rect = cursor.getBoundingClientRect();
            const x = (rect.left + rect.width/2) / window.innerWidth * 2 - 1;
            const y = -((rect.top + rect.height/2) / window.innerHeight) * 2 + 1;

            const raycaster = new THREE.Raycaster();
            const cam = document.querySelector('[camera]').object3D;
            raycaster.setFromCamera(new THREE.Vector2(x, y), document.querySelector('[camera]').components.camera.camera);

            // Raycast ke semua objek di dalam marker
            const markerGroup = document.querySelector('#marker-root').object3D;
            const intersects = raycaster.intersectObjects(markerGroup.children, true);

            for(let i=0; i<intersects.length; i++) {
                // Cari zombie parent
                let obj = intersects[i].object;
                while(obj.parent && obj.parent !== markerGroup) {
                    obj = obj.parent; // Naik ke entity utama zombie
                    if(obj.el && obj.el.classList.contains('zombie')) break; // Harusnya kita kasih class zombie
                }
                
                // Hapus zombie (obj.el adalah a-entity)
                if(obj.el && obj.el.parentNode) {
                    killZombie(obj.el);
                    break; // One shot one kill
                }
            }
        }

        function killZombie(el) {
            if(el.dataset.dead === 'true') return;
            el.dataset.dead = 'true';
            gameState.score++;
            document.getElementById('score').innerText = gameState.score;
            
            el.setAttribute('animation', 'property: rotation; to: -90 0 0; dur: 500');
            setTimeout(() => {
                if(el.parentNode) el.parentNode.removeChild(el);
                gameState.zombies = gameState.zombies.filter(z => z.el !== el);
            }, 500);
        }

        function damagePlayer() {
            gameState.hp -= 10;
            document.getElementById('hp-bar').style.width = gameState.hp + '%';
            const flash = document.getElementById('damage-flash');
            flash.style.opacity = 1; setTimeout(() => flash.style.opacity = 0, 200);
            if(gameState.hp <= 0) {
                gameState.running = false;
                document.getElementById('game-over-screen').style.display = 'flex';
            }
        }
    </script>
</body>
</html>
